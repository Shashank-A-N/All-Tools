<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chord Generator - Shadow Audio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../../styles.css">
    <style>
        .piano-key {
            transition: all 0.1s;
        }

        .piano-key.active {
            transform: scale(0.95);
            box-shadow: 0 0 15px currentColor;
        }

        .black-key {
            z-index: 10;
        }
    </style>
</head>

<body class="bg-gray-900 text-white font-sans antialiased overflow-x-hidden">

    <!-- Navbar -->
    <nav
        class="sticky top-0 z-50 glass-effect border-b border-white/5 px-6 py-4 flex items-center justify-between backdrop-blur-md">
        <div class="flex items-center gap-3">
            <a href="../index.html" class="flex items-center gap-2 group">
                <div
                    class="relative w-10 h-10 flex items-center justify-center bg-purple-600/20 rounded-lg border border-purple-500/30 group-hover:border-purple-500/50 transition-all">
                    <i class="fas fa-music text-purple-400 text-xl group-hover:scale-110 transition-transform"></i>
                </div>
                <div>
                    <h1 class="text-xl font-orbitron font-bold tracking-widest text-white">SHADOW<span
                            class="text-purple-500">AUDIO</span></h1>
                    <span class="text-xs text-slate-400 font-mono tracking-wider">HARMONY</span>
                </div>
            </a>
        </div>
        <a href="../index.html" class="text-slate-400 hover:text-white transition-colors"><i
                class="fas fa-times text-xl"></i></a>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-12 max-w-4xl">
        <div class="text-center mb-10">
            <h2 class="text-4xl font-bold font-orbitron mb-2">Chord Synthesizer</h2>
            <p class="text-slate-400 text-sm">Generate chords and visualize intervals.</p>
        </div>

        <div class="glass p-8 rounded-3xl border border-white/5 shadow-2xl">

            <div class="flex flex-col md:flex-row gap-8 mb-8">
                <!-- Controls -->
                <div class="flex-1 space-y-6">
                    <div>
                        <label class="block text-xs font-orbitron text-purple-400 mb-2">ROOT NOTE</label>
                        <select id="root-note"
                            class="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-lg font-mono tracking-wider focus:border-purple-500 outline-none">
                            <option value="C">C</option>
                            <option value="C#">C# / Db</option>
                            <option value="D">D</option>
                            <option value="D#">D# / Eb</option>
                            <option value="E">E</option>
                            <option value="F">F</option>
                            <option value="F#">F# / Gb</option>
                            <option value="G">G</option>
                            <option value="G#">G# / Ab</option>
                            <option value="A">A</option>
                            <option value="A#">A# / Bb</option>
                            <option value="B">B</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-orbitron text-blue-400 mb-2">CHORD TYPE</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="setChordType('Major')"
                                class="chord-type-btn active bg-purple-600 hover:bg-purple-500 p-2 rounded text-xs font-bold uppercase"
                                data-type="Major">Major</button>
                            <button onclick="setChordType('Minor')"
                                class="chord-type-btn bg-black/40 hover:bg-white/5 p-2 rounded text-xs font-bold uppercase border border-white/10"
                                data-type="Minor">Minor</button>
                            <button onclick="setChordType('7th')"
                                class="chord-type-btn bg-black/40 hover:bg-white/5 p-2 rounded text-xs font-bold uppercase border border-white/10"
                                data-type="7th">7th</button>
                            <button onclick="setChordType('Dim')"
                                class="chord-type-btn bg-black/40 hover:bg-white/5 p-2 rounded text-xs font-bold uppercase border border-white/10"
                                data-type="Dim">Dim</button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-orbitron text-slate-400 mb-2">WAVEFORM</label>
                        <div class="flex gap-2">
                            <button onclick="setWave('sine')"
                                class="wave-btn flex-1 p-2 rounded bg-purple-600/20 border border-purple-500/50 text-xs">Sine</button>
                            <button onclick="setWave('triangle')"
                                class="wave-btn flex-1 p-2 rounded bg-black/40 border border-white/10 text-xs">Tri</button>
                            <button onclick="setWave('square')"
                                class="wave-btn flex-1 p-2 rounded bg-black/40 border border-white/10 text-xs">Square</button>
                        </div>
                    </div>
                </div>

                <!-- Display -->
                <div
                    class="flex-1 flex flex-col justify-center items-center bg-black/20 rounded-2xl p-6 border border-white/5">
                    <div class="text-6xl font-bold font-mono text-white mb-2" id="chord-display">C</div>
                    <div class="text-xl text-purple-400 tracking-wide font-light tracking-[0.2em] uppercase"
                        id="chord-name">MAJOR</div>
                    <div class="mt-6 text-sm text-slate-500 font-mono" id="freq-display">261.6 Hz - 329.6 Hz - 392.0 Hz
                    </div>
                </div>
            </div>

            <!-- Piano Visual -->
            <div class="relative h-32 flex justify-center mb-8 select-none">
                <!-- Generated by JS -->
                <div id="piano-container" class="flex relative h-full"></div>
            </div>

            <button id="play-chord"
                class="w-full py-4 bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl font-bold font-orbitron text-xl shadow-lg hover:shadow-purple-500/30 hover:scale-[1.01] transition-all">
                PLAY CHORD
            </button>
        </div>
    </main>

    <script type="module">
        import { audioEngine } from '../shared/audio-utils.js';

        // NOTE FREQUENCIES (Middle C4)
        const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const baseFreqs = {
            'C': 261.63, 'C#': 277.18, 'D': 293.66, 'D#': 311.13, 'E': 329.63, 'F': 349.23,
            'F#': 369.99, 'G': 392.00, 'G#': 415.30, 'A': 440.00, 'A#': 466.16, 'B': 493.88
        };

        const intervals = {
            'Major': [0, 4, 7],
            'Minor': [0, 3, 7],
            '7th': [0, 4, 7, 10],
            'Dim': [0, 3, 6]
        };

        let currentType = 'Major';
        let currentWave = 'sine';
        let activeNodes = [];
        let isPlaying = false;

        // Init
        const rootSelect = document.getElementById('root-note');
        const playBtn = document.getElementById('play-chord');
        const display = document.getElementById('chord-display');
        const nameDisplay = document.getElementById('chord-name');
        const freqDisplay = document.getElementById('freq-display');
        const piano = document.getElementById('piano-container');

        // Draw Piano
        // Two octaves start from C
        const keyMap = []; // Store mapping to key elements
        for (let i = 0; i < 24; i++) {
            const noteIndex = i % 12;
            const noteParams = notes[noteIndex];
            const isBlack = noteParams.includes('#');

            const key = document.createElement('div');
            key.className = `piano-key ${isBlack ? 'black-key bg-black w-8 h-20 absolute -mx-4 top-0 border  border-slate-700' : 'white-key bg-white w-10 h-32 border border-slate-300'} rounded-b`;

            // Adjust margin for black keys
            if (isBlack) {
                // Calculation handled by HTML flow for white keys, absolute for black
                let whiteKeysBefore = 0;
                for (let j = 0; j < i; j++) {
                    if (!notes[j % 12].includes('#')) whiteKeysBefore++;
                }
                key.style.left = ((whiteKeysBefore * 2.5) - 0.7) + 'rem'; // Approx
            } else {
                key.style.marginRight = '0.1rem';
            }

            if (!isBlack) piano.appendChild(key); // Append white keys normally

            keyMap.push(key);
        }
        // Append black keys after to sit on top
        keyMap.forEach(k => { if (k.classList.contains('black-key')) piano.appendChild(k); });


        // Event Listeners
        rootSelect.addEventListener('change', updateUI);

        window.setChordType = (type) => {
            currentType = type;
            document.querySelectorAll('.chord-type-btn').forEach(b => {
                b.classList.remove('bg-purple-600', 'active');
                b.classList.add('bg-black/40');
                if (b.dataset.type === type) {
                    b.classList.add('bg-purple-600', 'active');
                    b.classList.remove('bg-black/40');
                }
            });
            updateUI();
        };

        window.setWave = (wave) => {
            currentWave = wave;
            document.querySelectorAll('.wave-btn').forEach(b => {
                b.classList.remove('bg-purple-600/20', 'border-purple-500/50');
                b.classList.add('bg-black/40');
                if (b.textContent.toLowerCase().includes(wave === 'triangle' ? 'tri' : wave)) {
                    b.classList.add('bg-purple-600/20', 'border-purple-500/50');
                    b.classList.remove('bg-black/40');
                }
            });
        };

        function getChordFrequencies() {
            const root = rootSelect.value;
            const rootIndex = notes.indexOf(root);
            const semitoneIntervals = intervals[currentType];

            return semitoneIntervals.map(interval => {
                const noteIndex = (rootIndex + interval) % 12;
                let octaveOffset = Math.floor((rootIndex + interval) / 12);
                const noteName = notes[noteIndex];
                const freq = baseFreqs[noteName] * Math.pow(2, octaveOffset); // Simple octave shift
                return { freq, note: noteName, index: rootIndex + interval };
            });
        }

        function updateUI() {
            const root = rootSelect.value;
            display.textContent = root;
            nameDisplay.textContent = currentType.toUpperCase();

            const chordData = getChordFrequencies();
            freqDisplay.textContent = chordData.map(c => c.freq.toFixed(1) + ' Hz').join(' - ');

            // Piano Visual
            keyMap.forEach(k => {
                k.style.backgroundColor = k.classList.contains('black-key') ? 'black' : 'white';
                k.style.transform = 'none';
                k.style.boxShadow = 'none';
                k.style.color = '';
            });

            chordData.forEach(c => {
                if (keyMap[c.index]) {
                    const k = keyMap[c.index];
                    k.style.backgroundColor = '#9333ea'; // Purple 600
                    k.style.transform = 'scale(0.95)';
                    k.style.boxShadow = '0 0 15px #9333ea';
                }
            });
        }

        playBtn.addEventListener('mousedown', () => {
            if (isPlaying) return;
            startChord();
        });

        playBtn.addEventListener('mouseup', stopChord);
        playBtn.addEventListener('mouseleave', stopChord);

        function startChord() {
            const ctx = audioEngine.init();
            const gain = ctx.createGain();
            gain.gain.value = 0.3;
            gain.connect(ctx.destination);

            const chordData = getChordFrequencies();

            activeNodes = chordData.map(c => {
                const osc = ctx.createOscillator();
                osc.type = currentWave;
                osc.frequency.value = c.freq;
                osc.connect(gain);
                osc.start();
                return osc;
            });

            isPlaying = true;
        }

        function stopChord() {
            activeNodes.forEach(n => n.stop());
            activeNodes = [];
            isPlaying = false;
        }

        updateUI(); // Init
    </script>
</body>

</html>