<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioForge Pro - Synth Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cyber: {
                            bg: '#05050a',
                            panel: '#0f111a',
                            primary: '#06b6d4', // Cyan
                            secondary: '#d946ef', // Fuchsia
                            text: '#e2e8f0',
                            muted: '#64748b'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        pulseGlow: {
                            '0%, 100%': { boxShadow: '0 0 10px #06b6d420' },
                            '50%': { boxShadow: '0 0 20px #06b6d450' }
                        },
                        shimmer: {
                            'from': { transform: 'translateX(-100%)' },
                            'to': { transform: 'translateX(100%)' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Responsive Scaling System */
        html {
            font-size: 12px;
        }

        /* Mobile Base */
        @media (min-width: 640px) {
            html {
                font-size: 13px;
            }
        }

        /* Tablet Portrait */
        @media (min-width: 768px) {
            html {
                font-size: 14px;
            }
        }

        /* Tablet Landscape */
        @media (min-width: 1024px) {
            html {
                font-size: 15px;
            }
        }

        /* Laptop */
        @media (min-width: 1280px) {
            html {
                font-size: 16px;
            }
        }

        /* Desktop */

        /* Modern Reset & Utilities */
        body {
            background: radial-gradient(circle at 50% 0%, #1e1b4b 0%, #05050a 100%);
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(15, 17, 26, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-panel {
            background: rgba(15, 17, 26, 0.9);
            backdrop-filter: blur(16px);
            border-top: 1px solid rgba(6, 182, 212, 0.1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #06b6d4;
        }

        /* Range Sliders */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #06b6d4;
            margin-top: -6px;
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.5);
            cursor: pointer;
            transition: transform 0.1s;
        }

        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }

        /* Region Styling */
        .region-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            background-color: rgba(217, 70, 239, 0.15);
            /* Cyber secondary low opacity */
            border-left: 1px solid rgba(217, 70, 239, 0.5);
            border-right: 1px solid rgba(217, 70, 239, 0.5);
            pointer-events: none;
            z-index: 15;
        }

        .region-marker::after {
            content: attr(data-label);
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 0.7rem;
            color: rgba(217, 70, 239, 0.8);
            font-family: monospace;
            background: rgba(0, 0, 0, 0.5);
            padding: 1px 3px;
            border-radius: 2px;
        }

        /* Mobile Adjustments */
        @media (max-width: 640px) {
            .mobile-hide-text {
                display: none;
            }

            .mobile-compact {
                padding: 0.5rem;
            }
        }

        /* Utility */
        .no-select {
            user-select: none;
        }
    </style>
</head>

<body
    class="text-cyber-text font-sans h-screen flex flex-col overflow-hidden selection:bg-cyber-primary selection:text-black">

    <!-- LANDING / SPLASH SCREEN -->
    <div id="landing-overlay"
        class="fixed inset-0 z-[100] bg-[#05050a] flex flex-col items-center justify-center transition-opacity duration-700">
        <!-- Background Elements -->
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div
                class="absolute top-1/4 left-1/4 w-96 h-96 bg-cyber-primary/10 rounded-full blur-[100px] animate-pulse">
            </div>
            <div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-cyber-secondary/10 rounded-full blur-[100px] animate-pulse"
                style="animation-delay: 1s;"></div>
        </div>

        <div class="relative z-10 text-center space-y-8 animate-float px-4">
            <div class="space-y-2">
                <div
                    class="inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-gradient-to-br from-cyber-panel to-black border border-white/10 shadow-2xl shadow-cyber-primary/20 mb-4">
                    <i class="fas fa-wave-square text-4xl text-cyber-primary"></i>
                </div>
                <h1 class="text-4xl md:text-6xl font-bold tracking-tight text-white">AudioForge <span
                        class="text-transparent bg-clip-text bg-gradient-to-r from-cyber-primary to-cyber-secondary">Pro</span>
                </h1>
                <p class="text-cyber-muted text-sm md:text-base max-w-md mx-auto">Professional Web-Based Audio Editing
                    Suite</p>
            </div>

            <button onclick="triggerUpload()"
                class="group relative px-8 py-4 bg-cyber-primary text-black font-bold rounded-xl text-lg hover:scale-105 transition-transform shadow-[0_0_30px_rgba(6,182,212,0.3)] hover:shadow-[0_0_50px_rgba(6,182,212,0.5)] overflow-hidden">
                <div
                    class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300">
                </div>
                <span class="relative flex items-center gap-3">
                    <i class="fas fa-cloud-upload-alt"></i> Open Audio File
                </span>
            </button>

            <p class="text-xs text-cyber-muted/50 mt-8">Supports MP3, WAV, OGG, FLAC</p>
        </div>
    </div>

    <!-- Hidden Input for File Handling -->
    <input type="file" id="file-upload" accept="audio/*" class="hidden">

    <!-- HEADER -->
    <header class="h-14 md:h-16 glass z-30 flex items-center justify-between px-4 md:px-6 shrink-0 relative">
        <div
            class="absolute bottom-0 left-0 w-full h-px bg-gradient-to-r from-transparent via-cyber-primary/20 to-transparent">
        </div>

        <div class="flex items-center gap-3 md:gap-4">
            <div
                class="relative w-8 h-8 md:w-10 md:h-10 bg-cyber-bg rounded-lg flex items-center justify-center border border-white/10 shrink-0">
                <i class="fas fa-wave-square text-cyber-primary text-sm md:text-base"></i>
            </div>
            <div class="min-w-0">
                <h1 class="text-base md:text-xl font-bold tracking-tight text-white truncate">AudioForge <span
                        class="text-cyber-primary font-light">Pro</span></h1>
            </div>
        </div>

        <div class="flex items-center gap-2">
            <!-- Undo/Redo Group -->
            <div class="flex items-center bg-black/20 p-1 rounded-lg border border-white/5">
                <button onclick="undo()" id="btn-undo"
                    class="w-8 h-8 flex items-center justify-center rounded text-cyber-muted hover:text-white hover:bg-white/5 transition-colors disabled:opacity-30"
                    title="Undo">
                    <i class="fas fa-undo text-xs"></i>
                </button>
                <button onclick="redo()" id="btn-redo"
                    class="w-8 h-8 flex items-center justify-center rounded text-cyber-muted hover:text-white hover:bg-white/5 transition-colors disabled:opacity-30"
                    title="Redo">
                    <i class="fas fa-redo text-xs"></i>
                </button>
            </div>

            <div class="hidden sm:block w-px h-5 bg-white/10 mx-1"></div>

            <button onclick="exportWav()" id="btn-export"
                class="px-3 py-1.5 md:px-5 md:py-2 rounded-lg bg-cyber-primary/10 hover:bg-cyber-primary/20 text-cyber-primary border border-cyber-primary/30 transition-all text-xs md:text-sm font-semibold flex items-center gap-2 disabled:opacity-50">
                <i class="fas fa-download"></i> <span class="hidden sm:inline">Export</span>
            </button>
        </div>
    </header>

    <!-- MAIN LAYOUT -->
    <div class="flex-1 flex overflow-hidden relative">

        <!-- LEFT SIDEBAR -->
        <aside
            class="w-12 lg:w-64 glass flex flex-col z-20 shrink-0 transition-all duration-300 border-r border-white/5">
            <div class="p-2 lg:p-4 flex flex-col gap-4 border-b border-white/5">
                <!-- Trigger Button -->
                <button onclick="triggerUpload()"
                    class="group relative overflow-hidden rounded-xl bg-gradient-to-br from-cyber-primary/20 to-cyber-secondary/20 p-[1px] w-full">
                    <div
                        class="flex h-full w-full items-center justify-center lg:justify-start rounded-xl bg-cyber-bg px-0 lg:px-3 py-3 text-sm font-medium text-white backdrop-blur-3xl gap-2 transition-colors group-hover:bg-cyber-bg/80">
                        <i class="fas fa-folder-open text-cyber-primary text-lg lg:text-sm"></i>
                        <span class="hidden lg:inline">Open File</span>
                    </div>
                </button>
            </div>

            <nav class="flex-1 overflow-y-auto p-2 lg:p-3 space-y-2 custom-scrollbar" id="tools-nav">
                <!-- Generated by JS -->
            </nav>

            <div class="p-4 text-center border-t border-white/5 hidden lg:block">
                <div class="text-[10px] text-cyber-muted uppercase tracking-widest">v2.5</div>
            </div>
        </aside>

        <!-- CENTER STAGE -->
        <main class="flex-1 flex flex-col min-w-0 bg-[#05050a] relative">

            <!-- TRANSPORT BAR -->
            <div class="h-14 glass flex items-center justify-between px-4 shrink-0 z-10 gap-2">
                <div class="flex items-center gap-2 md:gap-3">
                    <button onclick="togglePlay()" id="btn-play"
                        class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white text-black hover:scale-105 flex items-center justify-center transition-all shadow-[0_0_15px_rgba(255,255,255,0.3)] disabled:opacity-30 disabled:scale-100 disabled:shadow-none"
                        disabled>
                        <i class="fas fa-play ml-0.5 text-xs md:text-sm" id="icon-play"></i>
                    </button>
                    <button onclick="stopAudio()" id="btn-stop"
                        class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white/5 text-white hover:bg-white/10 flex items-center justify-center transition-colors disabled:opacity-30"
                        disabled>
                        <i class="fas fa-stop text-xs md:text-sm"></i>
                    </button>

                    <div
                        class="bg-black/40 px-3 py-1 md:py-1.5 rounded-full border border-white/5 flex items-center gap-2 min-w-[80px] md:min-w-[100px] justify-center">
                        <div class="w-1.5 h-1.5 md:w-2 md:h-2 rounded-full bg-red-500 animate-pulse"></div>
                        <span class="font-mono text-cyber-primary text-xs md:text-sm tracking-wider"
                            id="time-display">00:00.00</span>
                    </div>
                </div>

                <div class="flex items-center gap-2 md:gap-4 bg-black/20 p-1.5 md:p-2 rounded-lg border border-white/5">
                    <i class="fas fa-minus text-[10px] text-cyber-muted"></i>
                    <input type="range" id="zoom-slider" min="1" max="10" step="0.1" value="1"
                        class="w-20 md:w-32 range-slider disabled:opacity-30" disabled>
                    <i class="fas fa-plus text-[10px] text-cyber-muted"></i>
                </div>
            </div>

            <!-- VISUALIZATION AREA -->
            <div class="flex-1 relative overflow-auto custom-scrollbar group bg-black/40" id="waveform-container">
                <!-- Empty State (Fallback if overlay fails) -->
                <div id="welcome-screen" class="absolute inset-0 flex flex-col items-center justify-center z-0 hidden">
                    <p class="text-cyber-muted text-sm">File Loaded</p>
                </div>

                <!-- Canvas Wrapper -->
                <div id="canvas-wrapper" class="h-full relative min-w-full z-10">
                    <canvas id="waveform"
                        class="block h-full cursor-crosshair opacity-0 transition-opacity duration-500"></canvas>
                    <div id="regions-layer" class="absolute top-0 bottom-0 left-0 right-0 pointer-events-none z-15">
                    </div>
                    <div id="playhead"
                        class="absolute top-0 bottom-0 w-[1px] bg-white shadow-[0_0_15px_#ffffff] pointer-events-none hidden z-30">
                        <div
                            class="absolute top-0 -translate-x-1/2 -mt-1 text-[10px] text-white bg-black/50 px-1 rounded transform">
                            â–¼</div>
                    </div>
                    <div id="selection-overlay"
                        class="absolute top-0 bottom-0 bg-cyber-primary/10 border-x border-cyber-primary/50 pointer-events-none hidden z-20 backdrop-blur-[1px]">
                        <div class="absolute top-0 left-0 right-0 h-[2px] bg-cyber-primary shadow-[0_0_10px_#06b6d4]">
                        </div>
                        <div
                            class="absolute bottom-1 right-1 text-[9px] text-cyber-primary font-mono bg-black/50 px-1 rounded">
                            SELECTION</div>
                    </div>
                </div>
            </div>

            <!-- BOTTOM TOOL DRAWER -->
            <div id="tool-panel"
                class="absolute bottom-0 left-0 right-0 glass-panel border-t border-cyber-primary/20 p-4 md:p-6 transform translate-y-full transition-transform duration-300 ease-out z-40 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] h-[50vh] md:h-[400px] flex flex-col">
                <div class="max-w-6xl mx-auto w-full h-full flex flex-col">
                    <div class="flex justify-between items-start mb-4 shrink-0">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-8 h-8 md:w-10 md:h-10 rounded-lg bg-cyber-primary/10 flex items-center justify-center border border-cyber-primary/20">
                                <i id="tool-icon" class="fas fa-wrench text-cyber-primary text-sm md:text-base"></i>
                            </div>
                            <div>
                                <h3 id="tool-name"
                                    class="text-base md:text-lg font-bold text-white tracking-wide leading-tight">Tool
                                    Name</h3>
                                <p id="tool-desc" class="text-xs md:text-sm text-cyber-muted hidden sm:block">
                                    Description</p>
                            </div>
                        </div>
                        <button onclick="closeTool()" class="text-cyber-muted hover:text-white transition-colors p-2"><i
                                class="fas fa-times text-lg"></i></button>
                    </div>

                    <!-- Scrollable controls area -->
                    <div id="tool-controls" class="flex-1 overflow-y-auto custom-scrollbar pr-2">
                        <!-- Dynamic Controls -->
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast"
        class="fixed top-20 right-0 md:right-6 glass border-l-4 border-cyber-primary text-white px-4 py-3 rounded shadow-2xl transform translate-x-full transition-transform duration-300 flex items-center gap-4 z-50 max-w-[90vw]">
        <i class="fas fa-info-circle text-cyber-primary text-lg"></i>
        <div>
            <h4 class="font-bold text-xs uppercase tracking-wider text-cyber-primary">System</h4>
            <span id="toast-msg" class="text-xs md:text-sm text-gray-300">Notification</span>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONSTANTS & GLOBALS ---
        const MAX_HISTORY = 20;

        // App State
        const state = {
            audioContext: null,
            masterBuffer: null,
            isPlaying: false,
            startTime: 0,
            startOffset: 0,
            zoom: 1,
            selection: { start: 0, end: 0, active: false },
            regions: [],
            fileName: 'Untitled',
            history: [],
            historyIndex: -1,
            activeTool: null
        };

        // DOM Elements
        const el = {
            upload: document.getElementById('file-upload'),
            landing: document.getElementById('landing-overlay'),
            canvas: document.getElementById('waveform'),
            wrapper: document.getElementById('canvas-wrapper'),
            container: document.getElementById('waveform-container'),
            regionsLayer: document.getElementById('regions-layer'),
            playBtn: document.getElementById('btn-play'),
            stopBtn: document.getElementById('btn-stop'),
            playIcon: document.getElementById('icon-play'),
            timeDisplay: document.getElementById('time-display'),
            zoomSlider: document.getElementById('zoom-slider'),
            playhead: document.getElementById('playhead'),
            selection: document.getElementById('selection-overlay'),
            welcome: document.getElementById('welcome-screen'),
            status: document.getElementById('status-indicator'),
            undoBtn: document.getElementById('btn-undo'),
            redoBtn: document.getElementById('btn-redo'),
            exportBtn: document.getElementById('btn-export'),
            toolPanel: document.getElementById('tool-panel'),
            toolsNav: document.getElementById('tools-nav'),
            toolTitle: document.getElementById('tool-name'),
            toolDesc: document.getElementById('tool-desc'),
            toolIcon: document.getElementById('tool-icon'),
            toolControls: document.getElementById('tool-controls')
        };

        let animationFrame;
        let sourceNode = null;
        let resizeObserver;

        // --- INITIALIZATION ---
        window.addEventListener('load', () => {
            initAudioContext();
            setupEventListeners();
            renderToolsNav();

            resizeObserver = new ResizeObserver(() => {
                requestAnimationFrame(() => {
                    if (state.masterBuffer) {
                        drawWaveform();
                        updateOverlays();
                    }
                });
            });
            resizeObserver.observe(el.container);
        });

        function initAudioContext() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            state.audioContext = new AudioContext();
        }

        // --- FILE HANDLING & CONFIRMATION ---

        function triggerUpload() {
            // Double Confirmation Logic
            if (state.masterBuffer) {
                if (!confirm("Start a new project? Any unsaved changes to the current file will be lost.")) {
                    return;
                }
            }
            el.upload.click();
        }

        function setupEventListeners() {
            el.upload.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // Hide landing if visible
                if (!el.landing.classList.contains('opacity-0')) {
                    showToast('Loading engine...', 'info');
                } else {
                    showToast('Importing new file...', 'info');
                }

                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const decoded = await state.audioContext.decodeAudioData(arrayBuffer);

                    state.fileName = file.name.replace(/\.[^/.]+$/, "");
                    loadBuffer(decoded);

                    // Animate landing away
                    el.landing.classList.add('opacity-0', 'pointer-events-none');
                    el.canvas.classList.remove('opacity-0');
                    showToast('Audio ready for editing');

                } catch (err) {
                    console.error(err);
                    showToast('Failed to decode audio', 'error');
                } finally {
                    e.target.value = '';
                }
            });

            el.zoomSlider.addEventListener('input', (e) => {
                state.zoom = parseFloat(e.target.value);
                drawWaveform();
                updateOverlays();
            });

            let isDragging = false;

            el.wrapper.addEventListener('mousedown', (e) => {
                if (!state.masterBuffer) return;
                isDragging = true;
                const time = getTimeFromEvent(e);
                state.selection.start = time;
                state.selection.end = time;
                state.selection.active = true;
                state.startOffset = time;
                updateOverlays();
            });

            el.wrapper.addEventListener('touchstart', (e) => {
                if (!state.masterBuffer) return;
                isDragging = true;
                const touch = e.touches[0];
                const rect = el.canvas.getBoundingClientRect();
                let x = touch.clientX - rect.left;
                x = Math.max(0, Math.min(x, rect.width));
                const time = (x / rect.width) * state.masterBuffer.duration;

                state.selection.start = time;
                state.selection.end = time;
                state.selection.active = true;
                state.startOffset = time;
                updateOverlays();
            }, { passive: false });

            window.addEventListener('mousemove', (e) => {
                if (!isDragging || !state.masterBuffer) return;
                const time = getTimeFromEvent(e);
                state.selection.end = time;
                updateOverlays();
            });

            window.addEventListener('touchmove', (e) => {
                if (!isDragging || !state.masterBuffer) return;
                const touch = e.touches[0];
                const rect = el.canvas.getBoundingClientRect();
                let x = touch.clientX - rect.left;
                x = Math.max(0, Math.min(x, rect.width));
                const time = (x / rect.width) * state.masterBuffer.duration;

                state.selection.end = time;
                updateOverlays();
                e.preventDefault(); // Prevent scroll while selecting
            }, { passive: false });

            const endDrag = () => {
                if (isDragging) {
                    isDragging = false;
                    if (state.selection.start > state.selection.end) {
                        [state.selection.start, state.selection.end] = [state.selection.end, state.selection.start];
                    }
                    if (Math.abs(state.selection.end - state.selection.start) < 0.01) {
                        state.selection.active = false;
                        state.startOffset = state.selection.start;
                    }
                    updateOverlays();
                }
            };

            window.addEventListener('mouseup', endDrag);
            window.addEventListener('touchend', endDrag);

            window.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 'z') { e.preventDefault(); undo(); }
                    if (e.key === 'y') { e.preventDefault(); redo(); }
                }
                if (e.code === 'Space') {
                    if (document.activeElement.tagName !== 'INPUT') {
                        e.preventDefault();
                        togglePlay();
                    }
                }
            });
        }

        function getTimeFromEvent(e) {
            const rect = el.canvas.getBoundingClientRect();
            let x = e.clientX - rect.left;
            x = Math.max(0, Math.min(x, rect.width));
            return (x / rect.width) * state.masterBuffer.duration;
        }

        // --- CORE LOGIC ---
        function loadBuffer(buffer, pushToHistory = true) {
            if (pushToHistory) addToHistory(buffer);
            state.masterBuffer = buffer;
            stopAudio();
            state.selection = { start: 0, end: buffer.duration, active: false };
            state.startOffset = 0;
            state.regions = [];

            el.playBtn.disabled = false;
            el.stopBtn.disabled = false;
            el.zoomSlider.disabled = false;
            el.exportBtn.disabled = false;
            el.playhead.classList.remove('hidden');

            drawWaveform();
            updateOverlays();
            updateTimeDisplay(0);
        }

        function togglePlay() {
            if (!state.masterBuffer) return;
            state.isPlaying ? pauseAudio() : playAudio();
        }

        function playAudio() {
            if (!state.masterBuffer) return;
            if (sourceNode) sourceNode.stop();

            const source = state.audioContext.createBufferSource();
            source.buffer = state.masterBuffer;
            source.connect(state.audioContext.destination);

            let offset = state.startOffset;
            if (offset >= state.masterBuffer.duration) offset = 0;

            if (state.selection.active && Math.abs(state.selection.end - state.selection.start) > 0.1) {
                if (offset < state.selection.start || offset > state.selection.end) {
                    offset = state.selection.start;
                }
                source.start(0, offset, state.selection.end - offset);
            } else {
                source.start(0, offset);
            }

            state.startTime = state.audioContext.currentTime - offset;
            sourceNode = source;
            state.isPlaying = true;

            el.playIcon.className = "fas fa-pause";
            el.playhead.classList.remove('hidden');

            animate();
        }

        function pauseAudio() {
            if (sourceNode) {
                sourceNode.stop();
                sourceNode = null;
            }
            state.isPlaying = false;
            state.startOffset = state.audioContext.currentTime - state.startTime;
            el.playIcon.className = "fas fa-play ml-0.5";
            cancelAnimationFrame(animationFrame);
        }

        function stopAudio() {
            pauseAudio();
            state.startOffset = state.selection.active ? state.selection.start : 0;
            updateOverlays();
            updateTimeDisplay(state.startOffset);
        }

        function animate() {
            if (!state.isPlaying) return;
            const now = state.audioContext.currentTime - state.startTime;

            if (now >= state.masterBuffer.duration || (state.selection.active && now >= state.selection.end)) {
                pauseAudio();
                state.startOffset = state.selection.active ? state.selection.start : 0;
                updateOverlays();
                return;
            }

            state.startOffset = now;
            updateOverlays();
            updateTimeDisplay(now);
            animationFrame = requestAnimationFrame(animate);
        }

        // --- HISTORY ---
        function addToHistory(buffer) {
            if (state.historyIndex < state.history.length - 1) {
                state.history = state.history.slice(0, state.historyIndex + 1);
            }
            state.history.push(buffer);
            if (state.history.length > MAX_HISTORY) state.history.shift();
            state.historyIndex = state.history.length - 1;
            updateUndoRedoUI();
        }

        function undo() {
            if (state.historyIndex > 0) {
                state.historyIndex--;
                loadBuffer(state.history[state.historyIndex], false);
                updateUndoRedoUI();
                showToast('Action reverted', 'info');
            }
        }

        function redo() {
            if (state.historyIndex < state.history.length - 1) {
                state.historyIndex++;
                loadBuffer(state.history[state.historyIndex], false);
                updateUndoRedoUI();
                showToast('Action restored', 'info');
            }
        }

        function updateUndoRedoUI() {
            el.undoBtn.disabled = state.historyIndex <= 0;
            el.redoBtn.disabled = state.historyIndex >= state.history.length - 1;
        }

        // --- VISUALIZATION ---
        function drawWaveform() {
            if (!state.masterBuffer) return;

            const containerWidth = el.container.clientWidth;
            const height = el.container.clientHeight;
            const totalWidth = containerWidth * state.zoom;

            el.canvas.width = totalWidth;
            el.canvas.height = height;
            el.canvas.style.width = `${totalWidth}px`;

            const ctx = el.canvas.getContext('2d');
            const data = state.masterBuffer.getChannelData(0);

            ctx.clearRect(0, 0, totalWidth, height);

            // Center Line
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, height / 2);
            ctx.lineTo(totalWidth, height / 2);
            ctx.stroke();

            // Gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, '#d946ef'); // Fuchsia
            gradient.addColorStop(0.5, '#06b6d4'); // Cyan
            gradient.addColorStop(1, '#d946ef');

            ctx.fillStyle = gradient;

            const step = Math.ceil(data.length / totalWidth);
            const amp = height / 2;

            ctx.beginPath();
            for (let i = 0; i < totalWidth; i++) {
                let min = 1.0;
                let max = -1.0;
                const startIndex = i * step;

                for (let j = 0; j < step; j++) {
                    const datum = data[startIndex + j];
                    if (datum < min) min = datum;
                    if (datum > max) max = datum;
                }

                const y = (1 + min) * amp;
                const h = Math.max(1, (max - min) * amp);
                ctx.fillRect(i, y, 2, h);
            }
        }

        function updateOverlays() {
            if (!state.masterBuffer) return;
            const width = el.canvas.width;

            const playPos = (state.startOffset / state.masterBuffer.duration) * width;
            el.playhead.style.left = `${playPos}px`;

            if (state.isPlaying) {
                const containerWidth = el.container.clientWidth;
                const scrollLeft = el.container.scrollLeft;
                if (playPos > scrollLeft + containerWidth * 0.9) {
                    el.container.scrollLeft = playPos - containerWidth * 0.1;
                }
            }

            if (state.selection.active || (state.selection.start !== state.selection.end)) {
                el.selection.classList.remove('hidden');
                const startX = (state.selection.start / state.masterBuffer.duration) * width;
                const endX = (state.selection.end / state.masterBuffer.duration) * width;
                el.selection.style.left = `${startX}px`;
                el.selection.style.width = `${endX - startX}px`;
            } else {
                el.selection.classList.add('hidden');
            }

            renderRegionOverlays(width);
        }

        function renderRegionOverlays(canvasWidth) {
            el.regionsLayer.innerHTML = '';
            state.regions.forEach(region => {
                const startX = (region.start / state.masterBuffer.duration) * canvasWidth;
                const endX = (region.end / state.masterBuffer.duration) * canvasWidth;

                const div = document.createElement('div');
                div.className = 'region-marker';
                div.style.left = `${startX}px`;
                div.style.width = `${endX - startX}px`;
                div.setAttribute('data-label', region.label);
                el.regionsLayer.appendChild(div);
            });
        }

        // --- REGION MANAGEMENT ---
        function createRegion() {
            if (!checkSelection()) return;

            const newRegion = {
                id: Date.now(),
                label: `Region ${state.regions.length + 1}`,
                start: state.selection.start,
                end: state.selection.end
            };

            state.regions.push(newRegion);
            updateOverlays();
            renderRegionList();
            showToast('Region saved');
        }

        function renderRegionList() {
            const listContainer = document.getElementById('region-list-container');
            if (!listContainer) return;

            if (state.regions.length === 0) {
                listContainer.innerHTML = `<div class="text-center text-cyber-muted py-8 italic text-xs">No regions saved yet. Select an area and click "Create Region".</div>`;
                return;
            }

            listContainer.innerHTML = state.regions.map(r => `
                <div class="bg-black/40 border border-white/5 rounded-lg p-2 md:p-3 hover:border-cyber-primary/30 transition-colors flex flex-col md:flex-row items-start md:items-center justify-between group gap-2">
                    <div class="flex-1 min-w-0 w-full">
                        <div class="flex items-center gap-2 mb-1">
                            <i class="fas fa-tag text-cyber-secondary text-xs"></i>
                            <input type="text" value="${r.label}" class="bg-transparent border-none text-xs md:text-sm font-bold text-white w-full focus:ring-0 p-0" onchange="updateRegionLabel(${r.id}, this.value)">
                        </div>
                        <div class="text-[10px] md:text-xs text-cyber-muted font-mono">
                            ${formatTime(r.start)} - ${formatTime(r.end)}
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2 opacity-100 md:opacity-80 hover:opacity-100 w-full md:w-auto justify-end">
                        <button onclick="playRegion(${r.id})" class="p-1.5 hover:bg-white/10 rounded text-cyber-primary" title="Play Region">
                            <i class="fas fa-play text-xs"></i>
                        </button>
                        <button onclick="downloadRegion(${r.id})" class="p-1.5 hover:bg-white/10 rounded text-green-400" title="Download WAV">
                            <i class="fas fa-download text-xs"></i>
                        </button>
                        <button onclick="focusRegion(${r.id})" class="p-1.5 hover:bg-white/10 rounded text-yellow-400" title="Focus (Open in Editor)">
                            <i class="fas fa-expand-alt text-xs"></i>
                        </button>
                        <button onclick="deleteRegion(${r.id})" class="p-1.5 hover:bg-red-900/50 rounded text-red-500" title="Delete">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateRegionLabel(id, newLabel) {
            const region = state.regions.find(r => r.id === id);
            if (region) {
                region.label = newLabel;
                updateOverlays();
            }
        }

        function deleteRegion(id) {
            state.regions = state.regions.filter(r => r.id !== id);
            renderRegionList();
            updateOverlays();
        }

        function playRegion(id) {
            const region = state.regions.find(r => r.id === id);
            if (!region) return;
            if (sourceNode) sourceNode.stop();
            const source = state.audioContext.createBufferSource();
            source.buffer = state.masterBuffer;
            source.connect(state.audioContext.destination);
            source.start(0, region.start, region.end - region.start);
            state.startOffset = region.start;
            updateOverlays();
        }

        function downloadRegion(id) {
            const region = state.regions.find(r => r.id === id);
            if (!region) return;
            showToast('Preparing download...');
            const sliced = sliceBuffer(state.masterBuffer, region.start, region.end);
            setTimeout(() => {
                const blob = bufferToWave(sliced, sliced.length);
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${state.fileName}_${region.label.replace(/\s+/g, '_')}.wav`;
                link.click();
            }, 50);
        }

        function focusRegion(id) {
            const region = state.regions.find(r => r.id === id);
            if (!region) return;
            if (confirm(`Focus on "${region.label}"? This will replace the current workspace with this clip. You can undo this action.`)) {
                const sliced = sliceBuffer(state.masterBuffer, region.start, region.end);
                loadBuffer(sliced);
                showToast(`Focused on ${region.label}`);
            }
        }

        function sliceBuffer(buffer, startTime, endTime) {
            const sRate = buffer.sampleRate;
            const startFrame = Math.floor(startTime * sRate);
            const endFrame = Math.floor(endTime * sRate);
            const frameCount = endFrame - startFrame;
            const newBuffer = state.audioContext.createBuffer(buffer.numberOfChannels, frameCount, sRate);
            for (let c = 0; c < buffer.numberOfChannels; c++) {
                const oldData = buffer.getChannelData(c);
                const newData = newBuffer.getChannelData(c);
                for (let i = 0; i < frameCount; i++) {
                    newData[i] = oldData[startFrame + i];
                }
            }
            return newBuffer;
        }

        // --- TOOLS ---
        const TOOLS = [
            {
                id: 'trim', name: 'Region Manager', icon: 'fa-cut', desc: 'Create, play, and export multiple clips.',
                render: () => `
                    <div class="h-full flex flex-col gap-6">
                        <div class="flex flex-col md:flex-row items-start md:items-center gap-4 p-4 border border-dashed border-cyber-primary/30 rounded-xl bg-black/20 shrink-0">
                            <button onclick="createRegion()" class="bg-cyber-primary hover:bg-cyan-400 text-black px-6 py-3 rounded-lg font-bold shadow-lg shadow-cyan-500/20 transition-all flex items-center gap-2 w-full md:w-auto justify-center">
                                <i class="fas fa-plus"></i> <span>Create Region</span>
                            </button>
                            <div class="text-xs md:text-sm text-cyber-muted">
                                Select a range on the waveform, then click create.
                            </div>
                        </div>
                        <div class="flex-1 min-h-0 flex flex-col">
                            <h4 class="text-xs md:text-sm font-bold text-cyber-secondary mb-3 uppercase tracking-wider">Saved Regions</h4>
                            <div id="region-list-container" class="flex-1 overflow-y-auto custom-scrollbar space-y-2 pr-2">
                                <div class="text-center text-cyber-muted py-8 italic text-xs">No regions saved yet.</div>
                            </div>
                        </div>
                    </div>
                `
            },
            {
                id: 'fade', name: 'Fades', icon: 'fa-compress-arrows-alt', desc: 'Linear amplitude ramping.',
                render: () => `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                        <div class="bg-black/40 p-4 md:p-5 rounded-xl border border-white/5 hover:border-cyber-primary/30 transition-colors">
                            <h4 class="font-bold text-white mb-2 flex items-center gap-2 text-sm md:text-base"><i class="fas fa-long-arrow-alt-up text-cyber-primary"></i> Fade In</h4>
                            <p class="text-xs text-cyber-muted mb-4">Gradually increase volume from silence.</p>
                            <button onclick="applyFade('in')" class="w-full bg-cyber-primary text-black font-bold py-2 rounded hover:bg-cyan-300 transition-colors text-sm md:text-base">Apply Fade In</button>
                        </div>
                        <div class="bg-black/40 p-4 md:p-5 rounded-xl border border-white/5 hover:border-cyber-primary/30 transition-colors">
                            <h4 class="font-bold text-white mb-2 flex items-center gap-2 text-sm md:text-base"><i class="fas fa-long-arrow-alt-down text-cyber-secondary"></i> Fade Out</h4>
                            <p class="text-xs text-cyber-muted mb-4">Gradually decrease volume to silence.</p>
                            <button onclick="applyFade('out')" class="w-full bg-cyber-secondary text-black font-bold py-2 rounded hover:bg-fuchsia-300 transition-colors text-sm md:text-base">Apply Fade Out</button>
                        </div>
                    </div>
                `
            },
            {
                id: 'eq', name: 'Equalizer', icon: 'fa-sliders-h', desc: '3-Band Parametric EQ.',
                render: () => `
                    <div class="space-y-4 md:space-y-6 bg-black/40 p-4 md:p-6 rounded-xl border border-white/5">
                        ${['low', 'mid', 'high'].map(band => `
                            <div>
                                <div class="flex justify-between text-[10px] md:text-xs font-mono mb-2 text-cyber-muted">
                                    <span class="uppercase">${band}</span>
                                    <span id="val-${band}" class="text-cyber-primary">0 dB</span>
                                </div>
                                <input type="range" id="eq-${band}" min="-12" max="12" value="0" step="1" class="w-full" oninput="updateEqVal('${band}')">
                            </div>
                        `).join('')}
                        <button onclick="applyEq()" class="w-full mt-4 bg-white/10 hover:bg-white/20 text-white border border-white/20 py-2 rounded transition-colors text-sm md:text-base">Process EQ</button>
                    </div>
                `
            },
            {
                id: 'speed', name: 'Time/Pitch', icon: 'fa-tachometer-alt', desc: 'Resampling speed adjustment.',
                render: () => `
                     <div class="bg-black/40 p-4 md:p-6 rounded-xl border border-white/5 flex flex-col gap-4 md:gap-6">
                        <div>
                            <div class="flex justify-between text-sm mb-4"><span>Playback Rate</span> <span id="val-speed" class="font-mono text-cyber-secondary">1.0x</span></div>
                            <input type="range" id="speed-slider" min="0.5" max="2.0" value="1.0" step="0.1" class="w-full" oninput="document.getElementById('val-speed').innerText = this.value + 'x'">
                        </div>
                        <div class="text-[10px] md:text-xs text-cyber-muted">Note: Changing speed using this simple resampler will also affect pitch.</div>
                        <button onclick="applySpeed()" class="bg-gradient-to-r from-cyber-primary to-cyber-secondary text-black font-bold py-3 rounded hover:opacity-90 transition-opacity text-sm md:text-base">Apply Resample</button>
                    </div>
                `
            },
            {
                id: 'normalize', name: 'Normalize', icon: 'fa-arrows-alt-v', desc: 'Maximize gain to 0dB.',
                render: () => `
                    <div class="flex flex-col items-center justify-center text-center p-6 bg-black/40 rounded-xl border border-white/5 h-full">
                        <i class="fas fa-wave-square text-3xl md:text-4xl text-cyber-muted mb-4"></i>
                        <p class="text-cyber-muted max-w-sm mb-6 text-xs md:text-sm">Amplifies the entire signal so the highest peak hits the ceiling without clipping.</p>
                        <button onclick="applyNormalize()" class="bg-cyber-primary/20 text-cyber-primary border border-cyber-primary hover:bg-cyber-primary hover:text-black px-6 md:px-8 py-2 md:py-3 rounded font-bold transition-all text-sm md:text-base">
                            Normalize Audio
                        </button>
                    </div>
                `
            }
        ];

        function renderToolsNav() {
            el.toolsNav.innerHTML = TOOLS.map(t => `
                <button onclick="openTool('${t.id}')" class="w-full flex items-center gap-4 px-0 lg:px-4 py-3 rounded-xl text-cyber-muted hover:text-white hover:bg-white/5 transition-all text-left group border border-transparent hover:border-white/5 justify-center lg:justify-start">
                    <div class="w-8 h-8 rounded bg-black/40 flex items-center justify-center group-hover:text-cyber-primary transition-colors shrink-0">
                        <i class="fas ${t.icon} text-sm"></i>
                    </div>
                    <div class="hidden lg:block min-w-0">
                        <span class="block text-sm font-bold group-hover:text-cyber-primary transition-colors truncate">${t.name}</span>
                        <span class="block text-[10px] text-cyber-muted opacity-60 truncate">${t.desc.substring(0, 15)}...</span>
                    </div>
                </button>
            `).join('');
        }

        function openTool(id) {
            if (!state.masterBuffer) {
                showToast("Please open a file first", "error");
                return;
            }
            const tool = TOOLS.find(t => t.id === id);
            state.activeTool = id;

            el.toolTitle.innerText = tool.name;
            el.toolDesc.innerText = tool.desc;
            el.toolIcon.className = `fas ${tool.icon} text-cyber-primary text-sm md:text-base`;
            el.toolControls.innerHTML = tool.render();

            if (id === 'trim') {
                renderRegionList();
            }

            el.toolPanel.classList.remove('translate-y-full');
        }

        function closeTool() {
            el.toolPanel.classList.add('translate-y-full');
            state.activeTool = null;
        }

        // --- PROCESSING ---

        function applyNormalize() {
            setProcessing(true);
            const buffer = state.masterBuffer;
            let maxAmp = 0;
            for (let c = 0; c < buffer.numberOfChannels; c++) {
                const data = buffer.getChannelData(c);
                for (let i = 0; i < data.length; i++) {
                    const abs = Math.abs(data[i]);
                    if (abs > maxAmp) maxAmp = abs;
                }
            }
            if (maxAmp > 0) {
                const multiplier = 1.0 / maxAmp;
                const newBuffer = state.audioContext.createBuffer(buffer.numberOfChannels, buffer.length, buffer.sampleRate);
                for (let c = 0; c < buffer.numberOfChannels; c++) {
                    const oldData = buffer.getChannelData(c);
                    const newData = newBuffer.getChannelData(c);
                    for (let i = 0; i < buffer.length; i++) newData[i] = oldData[i] * multiplier;
                }
                loadBuffer(newBuffer);
                showToast('Peaks normalized to 0dB');
            }
            setProcessing(false);
        }

        function applyFade(type) {
            if (!checkSelection()) return;
            setProcessing(true);
            const buffer = state.masterBuffer;
            const sRate = buffer.sampleRate;
            const startFrame = Math.floor(state.selection.start * sRate);
            const endFrame = Math.floor(state.selection.end * sRate);
            const length = endFrame - startFrame;
            const newBuffer = state.audioContext.createBuffer(buffer.numberOfChannels, buffer.length, sRate);

            for (let c = 0; c < buffer.numberOfChannels; c++) {
                const oldData = buffer.getChannelData(c);
                const newData = newBuffer.getChannelData(c);
                newData.set(oldData);
                for (let i = 0; i < length; i++) {
                    const idx = startFrame + i;
                    let gain = type === 'in' ? i / length : 1 - (i / length);
                    newData[idx] = oldData[idx] * gain;
                }
            }
            loadBuffer(newBuffer);
            setProcessing(false);
            showToast(`Fade ${type} applied`);
        }

        async function applyEq() {
            setProcessing(true);
            const low = parseFloat(document.getElementById('eq-low').value);
            const mid = parseFloat(document.getElementById('eq-mid').value);
            const high = parseFloat(document.getElementById('eq-high').value);
            const offlineCtx = new OfflineAudioContext(state.masterBuffer.numberOfChannels, state.masterBuffer.length, state.masterBuffer.sampleRate);
            const source = offlineCtx.createBufferSource();
            source.buffer = state.masterBuffer;

            const fLow = offlineCtx.createBiquadFilter(); fLow.type = 'lowshelf'; fLow.frequency.value = 320; fLow.gain.value = low;
            const fMid = offlineCtx.createBiquadFilter(); fMid.type = 'peaking'; fMid.frequency.value = 1000; fMid.Q.value = 0.5; fMid.gain.value = mid;
            const fHigh = offlineCtx.createBiquadFilter(); fHigh.type = 'highshelf'; fHigh.frequency.value = 3200; fHigh.gain.value = high;

            source.connect(fLow); fLow.connect(fMid); fMid.connect(fHigh); fHigh.connect(offlineCtx.destination);
            source.start();
            const renderedBuffer = await offlineCtx.startRendering();
            loadBuffer(renderedBuffer);
            setProcessing(false);
            showToast('Equalization processed');
        }

        async function applySpeed() {
            setProcessing(true);
            const rate = parseFloat(document.getElementById('speed-slider').value);
            const newLength = state.masterBuffer.length / rate;
            const offlineCtx = new OfflineAudioContext(state.masterBuffer.numberOfChannels, newLength, state.masterBuffer.sampleRate);
            const source = offlineCtx.createBufferSource();
            source.buffer = state.masterBuffer;
            source.playbackRate.value = rate;
            source.connect(offlineCtx.destination);
            source.start();
            const renderedBuffer = await offlineCtx.startRendering();
            loadBuffer(renderedBuffer);
            setProcessing(false);
            showToast('Resampling complete');
        }

        function checkSelection() {
            if (!state.selection.active || Math.abs(state.selection.end - state.selection.start) < 0.05) {
                showToast('Select a region first', 'error');
                return false;
            }
            return true;
        }

        function updateEqVal(band) {
            const val = document.getElementById(`eq-${band}`).value;
            document.getElementById(`val-${band}`).innerText = (val > 0 ? '+' : '') + val + ' dB';
        }

        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            const ms = Math.floor((sec % 1) * 100);
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
        }

        function updateTimeDisplay(t) {
            el.timeDisplay.innerText = formatTime(t);
        }

        function setProcessing(isProc) {
            el.status.innerText = isProc ? "PROCESSING" : "READY";
            if (isProc) {
                el.status.className = 'text-xs text-cyber-secondary font-mono px-3 animate-pulse';
            } else {
                el.status.className = 'text-xs text-cyber-primary font-mono px-3';
            }
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            const icon = toast.querySelector('i');
            icon.className = type === 'error' ? 'fas fa-exclamation-triangle text-red-500 text-xl' : 'fas fa-info-circle text-cyber-primary text-xl';
            toast.style.borderLeftColor = type === 'error' ? '#ef4444' : '#06b6d4';

            toast.classList.remove('translate-x-full');
            setTimeout(() => toast.classList.add('translate-x-full'), 3000);
        }

        function exportWav() {
            if (!state.masterBuffer) return;
            setProcessing(true);
            showToast('Packaging audio data...');
            setTimeout(() => {
                const blob = bufferToWave(state.masterBuffer, state.masterBuffer.length);
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${state.fileName}_synth_edit.wav`;
                link.click();
                setProcessing(false);
                showToast('Export successful');
            }, 100);
        }

        function bufferToWave(abuffer, len) {
            let numOfChan = abuffer.numberOfChannels,
                length = len * numOfChan * 2 + 44,
                buffer = new ArrayBuffer(length),
                view = new DataView(buffer),
                channels = [], i, sample,
                offset = 0,
                pos = 0;
            function setUint16(data) { view.setUint16(pos, data, true); pos += 2; }
            function setUint32(data) { view.setUint32(pos, data, true); pos += 4; }
            setUint32(0x46464952); setUint32(length - 8); setUint32(0x45564157);
            setUint32(0x20746d66); setUint32(16); setUint16(1); setUint16(numOfChan);
            setUint32(abuffer.sampleRate); setUint32(abuffer.sampleRate * 2 * numOfChan);
            setUint16(numOfChan * 2); setUint16(16); setUint32(0x61746164);
            setUint32(length - pos - 40);
            for (i = 0; i < abuffer.numberOfChannels; i++) channels.push(abuffer.getChannelData(i));
            while (pos < length) {
                for (i = 0; i < numOfChan; i++) {
                    sample = Math.max(-1, Math.min(1, channels[i][offset]));
                    sample = (0.5 + sample < 0 ? sample * 32768 : sample * 32767) | 0;
                    view.setInt16(pos, sample, true);
                    pos += 2;
                }
                offset++;
            }
            return new Blob([buffer], { type: "audio/wav" });
        }
    </script>
</body>

</html>