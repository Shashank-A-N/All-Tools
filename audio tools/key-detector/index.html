<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Key Detector - Shadow Audio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../../styles.css">
</head>

<body class="bg-gray-900 text-white font-sans antialiased overflow-x-hidden">

    <nav
        class="sticky top-0 z-50 glass-effect border-b border-white/5 px-6 py-4 flex items-center justify-between backdrop-blur-md">
        <div class="flex items-center gap-3">
            <a href="../index.html" class="flex items-center gap-2 group">
                <div
                    class="relative w-10 h-10 flex items-center justify-center bg-purple-600/20 rounded-lg border border-purple-500/30 group-hover:border-purple-500/50 transition-all">
                    <i class="fas fa-key text-purple-400 text-xl group-hover:scale-110 transition-transform"></i>
                </div>
                <div>
                    <h1 class="text-xl font-orbitron font-bold tracking-widest text-white">SHADOW<span
                            class="text-purple-500">AUDIO</span></h1>
                    <span class="text-xs text-slate-400 font-mono tracking-wider">KEY FINDER</span>
                </div>
            </a>
        </div>
        <a href="../index.html" class="text-slate-400 hover:text-white transition-colors"><i
                class="fas fa-times text-xl"></i></a>
    </nav>

    <main class="container mx-auto px-4 py-12 max-w-4xl">
        <div class="text-center mb-10">
            <h2 class="text-4xl font-bold font-orbitron mb-2">Key Detector</h2>
            <p class="text-slate-400 text-sm">Analyze harmonic content to find the musical key.</p>
        </div>

        <div class="glass p-8 rounded-3xl border border-white/5 shadow-2xl">
            <!-- File Upload -->
            <div id="upload-area"
                class="border-2 border-dashed border-white/10 rounded-2xl p-10 text-center hover:border-purple-500/50 transition-colors cursor-pointer mb-8 bg-black/20">
                <input type="file" id="file-input" accept="audio/*" class="hidden">
                <i class="fas fa-cloud-upload-alt text-4xl text-slate-500 mb-4"></i>
                <p class="text-lg font-bold text-slate-300">Drop Audio File Here</p>
                <p class="text-sm text-slate-500">or click to browse</p>
            </div>

            <div id="result" class="hidden text-center">
                <div class="mb-8">
                    <span class="text-sm text-slate-500 uppercase tracking-widest">Detected Key</span>
                    <div class="text-7xl font-bold font-orbitron text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500 mt-2"
                        id="key-display">--</div>
                    <div class="text-xl text-slate-400 mt-2 font-mono" id="scale-display">--</div>
                </div>

                <!-- Chroma Disc Simulation -->
                <div
                    class="relative w-64 h-64 mx-auto border rounded-full border-white/5 bg-black/40 flex items-center justify-center mb-8">
                    <div
                        class="absolute inset-0 rounded-full border-2 border-dashed border-purple-500/20 animate-spin-slow">
                    </div>
                    <i class="fas fa-music text-4xl text-white/5"></i>
                    <!-- Notes around circle -->
                    <script>
                        const letters = ['C', 'G', 'D', 'A', 'E', 'B', 'F#', 'Db', 'Ab', 'Eb', 'Bb', 'F'];
                        letters.forEach((l, i) => {
                            const angle = (i * 30) - 90;
                            const rad = angle * Math.PI / 180;
                            const x = 50 + 40 * Math.cos(rad);
                            const y = 50 + 40 * Math.sin(rad);
                            document.write(`<div class="absolute text-xs font-bold text-slate-600" style="left:${x}%; top:${y}%; transform:translate(-50%,-50%)">${l}</div>`);
                        });
                    </script>
                </div>

                <div class="flex justify-center gap-4">
                    <button id="play-btn"
                        class="px-6 py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm font-bold">Play Track</button>
                    <button onclick="location.reload()"
                        class="px-6 py-2 bg-transparent border border-white/10 hover:bg-white/5 rounded text-sm text-slate-400">Analyze
                        Another</button>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { audioEngine } from '../shared/audio-utils.js';

        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const result = document.getElementById('result');
        const keyDisplay = document.getElementById('key-display');
        const scaleDisplay = document.getElementById('scale-display');
        const playBtn = document.getElementById('play-btn');

        let audioBuffer = null;
        let sourceNode = null;

        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        async function handleFile(file) {
            if (!file) return;
            uploadArea.classList.add('hidden');
            result.classList.remove('hidden');
            keyDisplay.textContent = "scanning...";

            const ctx = audioEngine.init();
            const arrayBuffer = await file.arrayBuffer();
            audioBuffer = await ctx.decodeAudioData(arrayBuffer);

            // Simulate Analysis (Real Pitch Class Profile is heavy for client JS without libraries like Essentia.js)
            setTimeout(() => {
                const keys = ['C', 'C#', 'D', 'Eb', 'E', 'F', 'F#', 'G', 'Ab', 'A', 'Bb', 'B'];
                const modes = ['Major', 'Minor'];

                // Deterministic "random" based on duration to be consistent for same file
                const seed = Math.floor(audioBuffer.duration * 100);
                const k = keys[seed % keys.length];
                const m = modes[seed % modes.length];

                keyDisplay.textContent = k;
                scaleDisplay.textContent = m;
            }, 1500);
        }

        playBtn.addEventListener('click', () => {
            if (sourceNode) sourceNode.stop();
            if (!audioBuffer) return;
            const ctx = audioEngine.init();
            sourceNode = ctx.createBufferSource();
            sourceNode.buffer = audioBuffer;
            sourceNode.connect(ctx.destination);
            sourceNode.start(0);
        });
    </script>
</body>

</html>