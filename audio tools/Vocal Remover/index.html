<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocal Remover - AudioForge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cyber: {
                            bg: '#05050a',
                            panel: 'rgba(21, 21, 30, 0.6)',
                            primary: '#06b6d4',
                            secondary: '#d946ef',
                            text: '#e2e8f0',
                            muted: '#64748b'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    boxShadow: {
                        'neon': '0 0 10px rgba(6, 182, 212, 0.5)',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: radial-gradient(circle at 50% 0%, #1e1b4b 0%, #05050a 100%);
            color: white;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>

<body class="min-h-screen flex flex-col font-sans overflow-hidden">

    <header class="h-16 glass z-50 flex items-center justify-between px-6 border-b border-white/5 shrink-0">
        <div class="flex items-center gap-3">
            <div
                class="w-8 h-8 rounded bg-gradient-to-br from-cyber-primary to-cyber-secondary flex items-center justify-center">
                <i class="fas fa-microphone-slash text-white text-sm"></i>
            </div>
            <h1 class="text-xl font-bold tracking-tight">AudioForge <span
                    class="text-cyber-secondary font-light">Karaoke</span></h1>
        </div>
        <a href="../index.html" class="text-xs text-cyber-muted hover:text-white transition-colors">
            <i class="fas fa-arrow-left mr-1"></i> Back to Tools
        </a>
    </header>

    <main class="flex-1 flex flex-col items-center justify-center p-6 relative">
        <div class="glass w-full max-w-lg rounded-2xl p-8 flex flex-col gap-6 shadow-2xl text-center">

            <h2 class="text-2xl font-bold">Vocal Isolation</h2>
            <p class="text-cyber-muted text-sm px-4">Removes center-panned vocals by phase cancellation. Works best on
                stereo tracks where vocals are dead center.</p>

            <div class="border-2 border-dashed border-white/10 rounded-xl p-6 bg-black/20 hover:border-cyber-secondary transition-colors cursor-pointer"
                onclick="document.getElementById('file-input').click()">
                <i class="fas fa-upload text-3xl text-cyber-secondary mb-2"></i>
                <div class="text-sm font-bold">Upload Stereo Song</div>
                <input type="file" id="file-input" accept="audio/*" class="hidden">
            </div>

            <div id="status" class="text-xs font-mono text-cyber-primary hidden">Processing...</div>

            <audio id="player" controls class="w-full hidden"></audio>

            <button id="download-btn"
                class="w-full py-3 rounded-lg bg-cyber-secondary text-white font-bold hidden hover:bg-fuchsia-400">
                Download Instrumental
            </button>
        </div>
    </main>

    <script>
        const fileInput = document.getElementById('file-input');
        const status = document.getElementById('status');
        const player = document.getElementById('player');
        const downloadBtn = document.getElementById('download-btn');

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            status.textContent = "Decoding...";
            status.classList.remove('hidden');
            player.classList.add('hidden');
            downloadBtn.classList.add('hidden');

            try {
                const arrayBuffer = await file.arrayBuffer();
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const originalBuffer = await audioCtx.decodeAudioData(arrayBuffer);

                status.textContent = "Processing logic (L - R)...";

                // Create Mono output buffer (1 channel)
                const length = originalBuffer.length;
                const outputBuffer = audioCtx.createBuffer(1, length, originalBuffer.sampleRate);

                const left = originalBuffer.getChannelData(0);
                const right = originalBuffer.getChannelData(1); // Error if mono
                const out = outputBuffer.getChannelData(0);

                if (originalBuffer.numberOfChannels < 2) {
                    alert("This tool requires a STEREO file.");
                    status.textContent = "Error: Input is Mono";
                    return;
                }

                // Phase cancellation loop
                for (let i = 0; i < length; i++) {
                    // Simple subtraction removes center-panned signals
                    out[i] = (left[i] - right[i]) / 2; // Normalize by 2 to prevent clipping
                }

                // Convert to WAV
                const wav = bufferToWave(outputBuffer, length);
                const url = URL.createObjectURL(wav);

                status.textContent = "Complete!";
                player.src = url;
                player.classList.remove('hidden');

                downloadBtn.classList.remove('hidden');
                downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "karaoke_version.wav";
                    a.click();
                };

            } catch (err) {
                console.error(err);
                status.textContent = "Error processing file.";
            }
        });

        // Reused simple WAV encoder
        function bufferToWave(abuffer, len) {
            let numOfChan = abuffer.numberOfChannels,
                length = len * numOfChan * 2 + 44,
                buffer = new ArrayBuffer(length),
                view = new DataView(buffer),
                channels = [], i, sample,
                offset = 0,
                pos = 0;

            setUint32(0x46464952); setUint32(length - 8); setUint32(0x45564157);
            setUint32(0x20746d66); setUint32(16); setUint16(1); setUint16(numOfChan);
            setUint32(abuffer.sampleRate); setUint32(abuffer.sampleRate * 2 * numOfChan);
            setUint16(numOfChan * 2); setUint16(16); setUint32(0x61746164); setUint32(length - pos - 4);

            for (i = 0; i < abuffer.numberOfChannels; i++) channels.push(abuffer.getChannelData(i));

            while (pos < len) {
                for (i = 0; i < numOfChan; i++) {
                    sample = Math.max(-1, Math.min(1, channels[i][pos]));
                    sample = (0.5 + sample < 0 ? sample * 32768 : sample * 32767) | 0;
                    view.setInt16(44 + offset, sample, true);
                    offset += 2;
                }
                pos++;
            }
            return new Blob([buffer], { type: "audio/wav" });
            function setUint16(d) { view.setUint16(pos, d, true); pos += 2; }
            function setUint32(d) { view.setUint32(pos, d, true); pos += 4; }
        }
    </script>
</body>

</html>