<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Multi-Crop Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: {
                            950: '#020617',
                            900: '#0f172a',
                            800: '#1e293b',
                            700: '#334155',
                            600: '#475569',
                        }
                    },
                    cursor: {
                        'crosshair': 'crosshair',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }

        /* Canvas Patterns */
        .bg-studio {
            background-color: #0f172a;
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        .bg-checkerboard {
            background-color: #1e293b;
            background-image:
                linear-gradient(45deg, #334155 25%, transparent 25%),
                linear-gradient(-45deg, #334155 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #334155 75%),
                linear-gradient(-45deg, transparent 75%, #334155 75%);
            background-size: 16px 16px;
            background-position: 0 0, 0 8px, 8px -8px, -8px 0px;
        }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 14px;
            width: 14px;
            border-radius: 50%;
            background: #3b82f6;
            margin-top: -5px;
            cursor: pointer;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #334155;
            border-radius: 2px;
        }

        /* Selection SVG Overlay */
        #selection-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: visible;
            z-index: 10;
        }

        .selection-path {
            fill: rgba(59, 130, 246, 0.1);
            stroke: #3b82f6;
            stroke-width: 1.5;
            stroke-dasharray: 4, 4;
            vector-effect: non-scaling-stroke;
        }

        /* Transform Box & Handles */
        #transform-box {
            position: absolute;
            pointer-events: none;
            z-index: 20;
            display: none;
        }

        /* The border of the transform box */
        .transform-border {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.5);
            pointer-events: none;
        }

        /* Hit area for moving */
        .move-area {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            cursor: move;
            pointer-events: auto;
            background: transparent;
        }

        .resize-handle {
            position: absolute;
            width: 16px;
            /* Larger touch target for mobile */
            height: 16px;
            background-color: #3b82f6;
            border: 2px solid white;
            border-radius: 50%;
            pointer-events: auto;
            z-index: 30;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            transition: transform 0.1s;
        }

        .resize-handle:hover {
            transform: translate(-50%, -50%) scale(1.2);
        }

        /* Handle Positions */
        .h-nw {
            top: 0;
            left: 0;
            cursor: nwse-resize;
        }

        .h-n {
            top: 0;
            left: 50%;
            cursor: ns-resize;
        }

        .h-ne {
            top: 0;
            right: 0;
            transform: translate(50%, -50%);
            cursor: nesw-resize;
        }

        .h-e {
            top: 50%;
            right: 0;
            transform: translate(50%, -50%);
            cursor: ew-resize;
        }

        .h-se {
            bottom: 0;
            right: 0;
            transform: translate(50%, 50%);
            cursor: nwse-resize;
        }

        .h-s {
            bottom: 0;
            left: 50%;
            transform: translate(-50%, 50%);
            cursor: ns-resize;
        }

        .h-sw {
            bottom: 0;
            left: 0;
            transform: translate(-50%, 50%);
            cursor: nesw-resize;
        }

        .h-w {
            top: 50%;
            left: 0;
            cursor: ew-resize;
        }

        .tool-btn.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        #stage {
            /* Ensure stage wraps image perfectly */
            display: inline-block;
            line-height: 0;
            max-width: 100%;
            max-height: 100%;
            touch-action: none;
            /* Crucial for drawing on mobile */
        }
    </style>
</head>

<body class="bg-dark-950 text-slate-200 h-screen flex flex-col select-none overflow-hidden">

    <!-- Header -->
    <header
        class="h-14 lg:h-16 bg-dark-900 border-b border-dark-800 flex items-center justify-between px-4 lg:px-5 shrink-0 z-30">
        <div class="flex items-center gap-2 lg:gap-3">
            <div
                class="bg-gradient-to-tr from-blue-600 to-indigo-600 p-1.5 lg:p-2 rounded-xl shadow-lg shadow-blue-900/20">
                <i data-lucide="scan-face" class="w-4 h-4 lg:w-5 lg:h-5 text-white"></i>
            </div>
            <div>
                <h1 class="font-bold text-sm lg:text-lg tracking-tight leading-tight whitespace-nowrap">Crop <span
                        class="text-blue-500">Studio</span></h1>
                <p class="hidden sm:block text-[10px] text-slate-500 font-medium">ADVANCED EXTRACTION</p>
            </div>
        </div>

        <!-- Tool Mode Switcher (Desktop Only) -->
        <div class="hidden lg:flex items-center bg-dark-800 p-1 rounded-lg border border-dark-700"
            id="tool-bar-desktop">
            <button
                class="tool-btn active px-3 py-1.5 rounded-md text-xs font-medium flex gap-2 items-center transition-all"
                data-tool="rect">
                <i data-lucide="box-select" class="w-3.5 h-3.5"></i> Box
            </button>
            <button class="tool-btn px-3 py-1.5 rounded-md text-xs font-medium flex gap-2 items-center transition-all"
                data-tool="circle">
                <i data-lucide="circle" class="w-3.5 h-3.5"></i> Circle
            </button>
            <button class="tool-btn px-3 py-1.5 rounded-md text-xs font-medium flex gap-2 items-center transition-all"
                data-tool="lasso">
                <i data-lucide="lasso" class="w-3.5 h-3.5"></i> Lasso
            </button>
        </div>

        <div class="flex items-center gap-2 lg:gap-3">
            <button id="reset-project"
                class="text-xs text-slate-400 hover:text-red-400 transition-colors bg-dark-800 lg:bg-transparent px-3 py-1.5 rounded-md">
                <span class="hidden sm:inline">Reset</span>
                <i data-lucide="rotate-ccw" class="w-4 h-4 sm:hidden"></i>
            </button>

            <div class="hidden lg:block w-px h-6 bg-dark-800"></div>

            <!-- Filters Toggle (Desktop Only) -->
            <button id="toggle-filters-desktop"
                class="hidden lg:flex bg-dark-800 hover:bg-dark-700 text-slate-200 px-3 py-1.5 rounded-md text-xs font-medium items-center gap-2 border border-dark-700 transition-colors">
                <i data-lucide="sliders-horizontal" class="w-3.5 h-3.5"></i> Adjust
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex-1 flex flex-col lg:flex-row overflow-hidden relative">

        <!-- Filter Sidebar (Desktop Static / Mobile Hidden via specific button) -->
        <div id="filter-panel"
            class="absolute left-0 top-0 bottom-0 z-40 lg:static lg:h-full w-0 overflow-hidden bg-dark-900 border-r border-dark-800 transition-all duration-300 flex flex-col shrink-0 shadow-2xl lg:shadow-none">
            <div class="p-4 min-w-[240px] h-full overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="font-semibold text-sm text-slate-100">Adjustments</h3>
                    <button id="reset-filters" class="text-[10px] text-blue-400 hover:text-blue-300">Reset</button>
                </div>

                <div class="space-y-5">
                    <div class="space-y-2">
                        <div class="flex justify-between text-[11px] text-slate-400"><span>Brightness</span> <span
                                id="val-brightness">100%</span></div>
                        <input type="range" class="filter-input w-full" data-filter="brightness" min="0" max="200"
                            value="100">
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-[11px] text-slate-400"><span>Contrast</span> <span
                                id="val-contrast">100%</span></div>
                        <input type="range" class="filter-input w-full" data-filter="contrast" min="0" max="200"
                            value="100">
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-[11px] text-slate-400"><span>Saturation</span> <span
                                id="val-saturate">100%</span></div>
                        <input type="range" class="filter-input w-full" data-filter="saturate" min="0" max="200"
                            value="100">
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-[11px] text-slate-400"><span>Blur</span> <span
                                id="val-blur">0px</span></div>
                        <input type="range" class="filter-input w-full" data-filter="blur" min="0" max="10" step="0.5"
                            value="0">
                    </div>
                </div>

                <!-- Close button for mobile -->
                <button id="close-filters-mobile"
                    class="lg:hidden mt-8 w-full bg-dark-800 text-slate-300 py-2 rounded-lg text-xs">Close
                    Panel</button>
            </div>
        </div>

        <!-- Main Workspace -->
        <!-- Added padding-bottom for mobile to account for navbar -->
        <div
            class="flex-1 bg-studio relative flex items-center justify-center p-4 lg:p-12 pb-[80px] lg:pb-12 overflow-hidden order-1 lg:order-2">

            <!-- Upload View -->
            <div id="upload-zone"
                class="absolute inset-0 z-50 flex items-center justify-center bg-dark-950 transition-opacity duration-300">
                <div class="text-center space-y-6 max-w-lg w-full p-6">
                    <div
                        class="border-2 border-dashed border-dark-700 bg-dark-900/50 rounded-2xl p-8 lg:p-12 hover:border-blue-500 hover:bg-dark-800/50 transition-all cursor-pointer group relative">
                        <input type="file" id="file-input" accept="image/*"
                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                        <div class="group-hover:scale-105 transition-transform duration-300">
                            <div
                                class="w-12 h-12 lg:w-16 lg:h-16 bg-dark-800 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-blue-600/20 group-hover:text-blue-400 transition-colors">
                                <i data-lucide="image-plus"
                                    class="w-6 h-6 lg:w-8 lg:h-8 text-slate-400 group-hover:text-blue-500"></i>
                            </div>
                            <h2 class="text-lg lg:text-xl font-bold text-slate-200">Open Image</h2>
                            <p class="text-xs lg:text-sm text-slate-500 mt-2">Tap to upload or Drag & Drop</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Image Stage -->
            <div id="stage" class="relative shadow-2xl shadow-black/50 hidden touch-none">
                <!-- The Main Image -->
                <img id="main-image" src=""
                    class="block max-w-full max-h-[70vh] lg:max-h-[80vh] object-contain select-none pointer-events-none"
                    draggable="false">

                <!-- Drawing Overlay (SVG) -->
                <svg id="selection-svg">
                    <path id="active-path" class="selection-path hidden"></path>
                    <rect id="active-rect" class="selection-path hidden"></rect>
                    <ellipse id="active-circle" class="selection-path hidden"></ellipse>
                </svg>

                <!-- Transform Box (Handles) -->
                <div id="transform-box">
                    <div class="move-area" title="Drag to Move"></div>
                    <div class="transform-border"></div>
                    <!-- 8 Handles -->
                    <div class="resize-handle h-nw" data-handle="nw"></div>
                    <div class="resize-handle h-n" data-handle="n"></div>
                    <div class="resize-handle h-ne" data-handle="ne"></div>
                    <div class="resize-handle h-e" data-handle="e"></div>
                    <div class="resize-handle h-se" data-handle="se"></div>
                    <div class="resize-handle h-s" data-handle="s"></div>
                    <div class="resize-handle h-sw" data-handle="sw"></div>
                    <div class="resize-handle h-w" data-handle="w"></div>
                </div>

                <!-- Crop Actions Floating Menu -->
                <div id="crop-menu"
                    class="absolute hidden z-50 transform -translate-x-1/2 mt-4 animate-in slide-in-from-top-2 fade-in">
                    <div class="bg-dark-800 border border-dark-700 rounded-full shadow-xl flex items-center p-1 gap-1">
                        <button id="cancel-crop"
                            class="p-2 hover:bg-dark-700 rounded-full text-slate-400 hover:text-white transition-colors"
                            title="Cancel (Esc)">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                        <div class="w-px h-4 bg-dark-700"></div>
                        <button id="confirm-crop"
                            class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded-full text-xs font-bold flex items-center gap-2 transition-colors shadow-lg shadow-blue-900/50">
                            <i data-lucide="scissors" class="w-3.5 h-3.5"></i> Extract
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Library Panel (Mobile: Bottom Sheet / Desktop: Sidebar) -->
        <div id="library-panel"
            class="fixed bottom-[60px] inset-x-0 h-72 bg-dark-900 z-30 border-t border-dark-800 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] transform transition-transform duration-300 translate-y-[150%] lg:translate-y-0 lg:static lg:w-72 lg:h-auto lg:border-l lg:border-t-0 lg:flex lg:flex-col lg:shrink-0 lg:z-20 lg:order-3 lg:shadow-none">
            <div class="p-3 lg:p-4 border-b border-dark-800 flex justify-between items-center bg-dark-800/30">
                <h2 class="font-semibold text-xs lg:text-sm text-slate-200">Library</h2>
                <div class="flex items-center gap-2">
                    <span id="crop-counter"
                        class="text-[10px] bg-dark-800 text-slate-400 px-2 py-0.5 rounded-full">0</span>
                    <button id="close-library-mobile" class="lg:hidden text-slate-400 hover:text-white"><i
                            data-lucide="chevron-down" class="w-4 h-4"></i></button>
                </div>
            </div>

            <button id="open-download-modal" disabled
                class="mx-3 lg:mx-4 mt-3 bg-slate-800 hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed text-slate-200 py-2 lg:py-2.5 rounded-lg text-xs font-bold flex items-center justify-center gap-2 transition-all shadow-md">
                <i data-lucide="archive" class="w-3.5 h-3.5"></i> Download All
            </button>

            <div id="crops-container" class="flex-1 overflow-y-auto p-3 lg:p-4 space-y-3 custom-scrollbar">
                <!-- Empty State -->
                <div id="empty-state"
                    class="h-full flex flex-col items-center justify-center text-slate-600 space-y-2 py-4">
                    <i data-lucide="layers" class="w-8 h-8 lg:w-10 lg:h-10 opacity-20"></i>
                    <p class="text-[10px] lg:text-xs text-center">Select area<br>to extract</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Bottom Navigation Bar -->
    <nav
        class="lg:hidden fixed bottom-0 left-0 right-0 h-[60px] bg-dark-900 border-t border-dark-800 flex items-center justify-between px-4 z-50">
        <!-- Tools -->
        <div class="flex bg-dark-800 rounded-lg p-1 gap-1">
            <button class="tool-btn active p-2 rounded-md transition-all text-slate-400" data-tool="rect">
                <i data-lucide="box-select" class="w-5 h-5"></i>
            </button>
            <button class="tool-btn p-2 rounded-md transition-all text-slate-400" data-tool="circle">
                <i data-lucide="circle" class="w-5 h-5"></i>
            </button>
            <button class="tool-btn p-2 rounded-md transition-all text-slate-400" data-tool="lasso">
                <i data-lucide="lasso" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- Panels -->
        <div class="flex gap-4">
            <button id="mobile-toggle-filters"
                class="flex flex-col items-center justify-center gap-0.5 text-slate-400 hover:text-white">
                <i data-lucide="sliders-horizontal" class="w-5 h-5"></i>
                <span class="text-[9px] font-medium">Adjust</span>
            </button>
            <button id="mobile-toggle-library"
                class="flex flex-col items-center justify-center gap-0.5 text-slate-400 hover:text-white relative">
                <i data-lucide="layers" class="w-5 h-5"></i>
                <span class="text-[9px] font-medium">Library</span>
                <span id="mobile-lib-badge"
                    class="absolute -top-1 -right-1 w-2.5 h-2.5 bg-blue-500 rounded-full border-2 border-dark-900 hidden"></span>
            </button>
        </div>
    </nav>

    <!-- Reset Confirmation Modal -->
    <div id="reset-modal"
        class="fixed inset-0 z-[100] bg-dark-950/90 backdrop-blur-sm hidden flex items-center justify-center opacity-0 transition-opacity duration-200">
        <div class="bg-dark-900 border border-dark-700 rounded-xl shadow-2xl max-w-sm w-full mx-4 p-6 transform scale-95 transition-transform duration-200"
            id="reset-modal-content">
            <div class="flex items-center gap-3 mb-4 text-red-500">
                <div class="bg-red-500/10 p-2 rounded-full"><i data-lucide="alert-triangle" class="w-6 h-6"></i></div>
                <h3 class="font-bold text-lg text-slate-200">Reset Project?</h3>
            </div>
            <p class="text-sm text-slate-400 mb-6">This will remove the current image and delete all extracted crops.
                This action cannot be undone.</p>

            <div class="flex gap-3">
                <button id="cancel-reset"
                    class="flex-1 bg-dark-800 hover:bg-dark-700 text-slate-300 py-2.5 rounded-lg text-sm font-medium transition-colors">Cancel</button>
                <button id="confirm-reset"
                    class="flex-1 bg-red-600 hover:bg-red-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-red-900/20 transition-colors">Yes,
                    Reset</button>
            </div>
        </div>
    </div>

    <!-- Export Options Modal -->
    <div id="download-modal"
        class="fixed inset-0 z-[100] bg-dark-950/90 backdrop-blur-sm hidden flex items-center justify-center opacity-0 transition-opacity duration-200">
        <div class="bg-dark-900 border border-dark-700 rounded-xl shadow-2xl max-w-sm w-full mx-4 p-6 transform scale-95 transition-transform duration-200"
            id="download-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-slate-200 text-lg">Export Options</h3>
                <button id="close-dl-modal" class="text-slate-400 hover:text-white"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>

            <div class="space-y-6">
                <div class="space-y-2">
                    <label class="text-xs text-slate-400 font-medium uppercase tracking-wider">Format</label>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="format" value="image/png" class="peer sr-only" checked>
                            <div
                                class="bg-dark-800 border border-dark-700 text-slate-400 text-center py-2 rounded-lg text-sm peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-500 transition-all font-medium">
                                PNG</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="format" value="image/jpeg" class="peer sr-only">
                            <div
                                class="bg-dark-800 border border-dark-700 text-slate-400 text-center py-2 rounded-lg text-sm peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-500 transition-all font-medium">
                                JPG</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="format" value="image/webp" class="peer sr-only">
                            <div
                                class="bg-dark-800 border border-dark-700 text-slate-400 text-center py-2 rounded-lg text-sm peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-500 transition-all font-medium">
                                WEBP</div>
                        </label>
                    </div>
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between text-xs text-slate-400 font-medium">
                        <span class="uppercase tracking-wider">Quality</span>
                        <span id="quality-val">90%</span>
                    </div>
                    <input type="range" id="dl-quality-slider" min="0.1" max="1" step="0.1" value="0.9" class="w-full">
                </div>

                <button id="confirm-download"
                    class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg text-sm font-bold shadow-lg shadow-blue-900/20 transition-all flex items-center justify-center gap-2">
                    <i data-lucide="download" class="w-4 h-4"></i> Download File(s)
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal"
        class="fixed inset-0 z-[100] bg-dark-950/90 backdrop-blur-sm hidden flex items-center justify-center opacity-0 transition-opacity duration-200">
        <div class="bg-dark-900 border border-dark-700 rounded-xl shadow-2xl max-w-4xl w-full mx-4 flex flex-col max-h-[90vh] overflow-hidden transform scale-95 transition-transform duration-200"
            id="edit-modal-content">
            <div class="p-4 border-b border-dark-800 flex justify-between items-center bg-dark-800/50">
                <h3 class="font-bold text-slate-200">Edit Asset</h3>
                <button id="close-modal" class="text-slate-400 hover:text-white"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>
            <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
                <div class="flex-1 bg-checkerboard p-8 flex items-center justify-center relative min-h-[200px]">
                    <img id="modal-preview-img" src=""
                        class="max-w-full max-h-[40vh] lg:max-h-[60vh] object-contain shadow-lg">
                </div>
                <div
                    class="w-full lg:w-72 bg-dark-900 border-t lg:border-t-0 lg:border-l border-dark-800 p-6 flex flex-col overflow-y-auto max-h-[40vh] lg:max-h-full">
                    <div class="space-y-6 flex-1">
                        <div class="space-y-2"><label class="text-xs text-slate-400 flex justify-between">Brightness
                                <span id="m-val-brightness">100%</span></label><input type="range"
                                class="modal-filter w-full" data-filter="brightness" min="0" max="200" value="100">
                        </div>
                        <div class="space-y-2"><label class="text-xs text-slate-400 flex justify-between">Contrast <span
                                    id="m-val-contrast">100%</span></label><input type="range"
                                class="modal-filter w-full" data-filter="contrast" min="0" max="200" value="100"></div>
                        <div class="space-y-2"><label class="text-xs text-slate-400 flex justify-between">Saturation
                                <span id="m-val-saturate">100%</span></label><input type="range"
                                class="modal-filter w-full" data-filter="saturate" min="0" max="200" value="100"></div>
                        <div class="space-y-2"><label class="text-xs text-slate-400 flex justify-between">Blur <span
                                    id="m-val-blur">0px</span></label><input type="range" class="modal-filter w-full"
                                data-filter="blur" min="0" max="10" step="0.5" value="0"></div>
                    </div>
                    <div class="pt-6 border-t border-dark-800 mt-4 space-y-3">
                        <button id="save-modal-changes"
                            class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg text-sm font-bold shadow-lg shadow-blue-900/20 transition-colors">Apply
                            Changes</button>
                        <button id="cancel-modal"
                            class="w-full bg-dark-800 hover:bg-dark-700 text-slate-300 py-2 rounded-lg text-sm transition-colors">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Core State ---
        const state = {
            imageSrc: null,
            crops: [],

            globalFilters: { brightness: 100, contrast: 100, saturate: 100, blur: 0 },
            modalFilters: { brightness: 100, contrast: 100, saturate: 100, blur: 0 },
            editingCropId: null,
            downloadMode: null,
            singleDownloadId: null,

            // Tool & Interaction
            currentTool: 'rect',
            interactionMode: 'none',

            // Selection Data
            startPoint: null,
            lassoPath: [],

            // The active selection bounding box 
            selectionBox: null,

            // Transform Data
            transformStart: null,
            activeHandle: null,
        };

        // --- DOM Elements ---
        const els = {
            stage: document.getElementById('stage'),
            mainImage: document.getElementById('main-image'),
            selectionSvg: document.getElementById('selection-svg'),
            transformBox: document.getElementById('transform-box'),
            cropMenu: document.getElementById('crop-menu'),

            activePath: document.getElementById('active-path'),
            activeRect: document.getElementById('active-rect'),
            activeCircle: document.getElementById('active-circle'),

            // Inputs
            fileInput: document.getElementById('file-input'),

            // Others
            uploadZone: document.getElementById('upload-zone'),
            cropsContainer: document.getElementById('crops-container'),
            emptyState: document.getElementById('empty-state'),
            editModal: document.getElementById('edit-modal'),
            modalPreviewImg: document.getElementById('modal-preview-img'),

            // Download Modal
            downloadModal: document.getElementById('download-modal'),
            downloadModalContent: document.getElementById('download-modal-content'),
            dlQualitySlider: document.getElementById('dl-quality-slider'),

            // Reset Modal
            resetModal: document.getElementById('reset-modal'),
            resetModalContent: document.getElementById('reset-modal-content'),
            confirmResetBtn: document.getElementById('confirm-reset'),
            cancelResetBtn: document.getElementById('cancel-reset'),

            // Filters Panel
            filterPanel: document.getElementById('filter-panel'),
            toggleFiltersBtn: document.getElementById('toggle-filters-desktop'),
            mobileToggleFiltersBtn: document.getElementById('mobile-toggle-filters'),
            closeFiltersMobileBtn: document.getElementById('close-filters-mobile'),

            // Library Panel
            libraryPanel: document.getElementById('library-panel'),
            mobileToggleLibraryBtn: document.getElementById('mobile-toggle-library'),
            closeLibraryMobileBtn: document.getElementById('close-library-mobile'),
            mobileLibBadge: document.getElementById('mobile-lib-badge'),
        };

        // --- Init ---
        lucide.createIcons();

        // Window Resize Observer
        const resizeObserver = new ResizeObserver(() => {
            if (state.imageSrc) {
                window.requestAnimationFrame(() => updateStageDimensions());
            }
        });
        resizeObserver.observe(els.mainImage);

        // --- Event Listeners ---

        // File Loading
        els.fileInput.addEventListener('change', (e) => loadFile(e.target.files[0]));
        window.addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].kind === 'file') loadFile(items[i].getAsFile());
            }
        });

        // Tool Switching
        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                // Sync mobile and desktop tool active state based on data attribute
                const tool = btn.dataset.tool;
                document.querySelectorAll(`[data-tool="${tool}"]`).forEach(b => b.classList.add('active'));

                state.currentTool = tool;
                resetSelection();
            });
        });

        // Stage Interactions
        els.stage.addEventListener('mousedown', handleMouseDown);
        window.addEventListener('mousemove', handleMouseMove);
        window.addEventListener('mouseup', handleMouseUp);

        // Touch events for mobile
        els.stage.addEventListener('touchstart', (e) => handleMouseDown(e.touches[0]));
        window.addEventListener('touchmove', (e) => handleMouseMove(e.touches[0]), { passive: false });
        window.addEventListener('touchend', handleMouseUp);

        // Filter Toggle Logic
        const toggleFilters = () => {
            const panel = els.filterPanel;
            if (panel.style.width === '240px' || panel.style.width === '100%') {
                panel.style.width = '0';
            } else {
                panel.style.width = window.innerWidth < 1024 ? '100%' : '240px';
            }
        };
        els.toggleFiltersBtn.addEventListener('click', toggleFilters);
        els.mobileToggleFiltersBtn.addEventListener('click', toggleFilters);
        els.closeFiltersMobileBtn.addEventListener('click', () => els.filterPanel.style.width = '0');

        // Library Toggle Logic (Mobile)
        const toggleLibrary = () => {
            const panel = els.libraryPanel;
            if (panel.classList.contains('translate-y-[150%]')) {
                panel.classList.remove('translate-y-[150%]');
                els.mobileLibBadge.classList.add('hidden'); // Clear badge on open
            } else {
                panel.classList.add('translate-y-[150%]');
            }
        };
        els.mobileToggleLibraryBtn.addEventListener('click', toggleLibrary);
        els.closeLibraryMobileBtn.addEventListener('click', () => els.libraryPanel.classList.add('translate-y-[150%]'));

        // Filters Input
        document.querySelectorAll('.filter-input').forEach(input => {
            input.addEventListener('input', (e) => {
                state.globalFilters[e.target.dataset.filter] = parseFloat(e.target.value);
                document.getElementById(`val-${e.target.dataset.filter}`).innerText = e.target.value + '%';
                applyGlobalFilters();
            });
        });

        // Crop Actions
        document.getElementById('confirm-crop').addEventListener('click', performCrop);
        document.getElementById('cancel-crop').addEventListener('click', resetSelection);
        document.getElementById('open-download-modal').addEventListener('click', () => openDownloadModal('all'));

        // Reset Logic
        const openReset = () => {
            els.resetModal.classList.remove('hidden');
            setTimeout(() => {
                els.resetModal.classList.remove('opacity-0');
                els.resetModalContent.classList.remove('scale-95');
            }, 10);
        };
        document.getElementById('reset-project').addEventListener('click', openReset);

        function closeResetModal() {
            els.resetModal.classList.add('opacity-0');
            els.resetModalContent.classList.add('scale-95');
            setTimeout(() => els.resetModal.classList.add('hidden'), 200);
        }

        els.cancelResetBtn.addEventListener('click', closeResetModal);
        els.confirmResetBtn.addEventListener('click', () => location.reload());

        // Edit Modal
        document.getElementById('close-modal').addEventListener('click', closeModal);
        document.getElementById('cancel-modal').addEventListener('click', closeModal);
        document.getElementById('save-modal-changes').addEventListener('click', saveEditedCrop);
        document.querySelectorAll('.modal-filter').forEach(input => {
            input.addEventListener('input', (e) => {
                state.modalFilters[e.target.dataset.filter] = parseFloat(e.target.value);
                applyModalFilters();
            });
        });

        // Download Modal Events
        document.getElementById('close-dl-modal').addEventListener('click', closeDownloadModal);
        document.getElementById('confirm-download').addEventListener('click', executeDownload);
        els.dlQualitySlider.addEventListener('input', (e) => {
            document.getElementById('quality-val').innerText = Math.round(e.target.value * 100) + '%';
        });

        // --- Logic: File & Filter ---
        function loadFile(file) {
            if (!file || !file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                state.imageSrc = e.target.result;
                els.mainImage.src = state.imageSrc;
                els.mainImage.onload = () => {
                    els.uploadZone.classList.add('opacity-0', 'pointer-events-none');
                    els.stage.classList.remove('hidden');
                    window.requestAnimationFrame(() => updateStageDimensions());
                };
            };
            reader.readAsDataURL(file);
        }

        function updateStageDimensions() {
            const rect = els.mainImage.getBoundingClientRect();
            els.selectionSvg.setAttribute('viewBox', `0 0 ${rect.width} ${rect.height}`);
            els.selectionSvg.style.width = rect.width + 'px';
            els.selectionSvg.style.height = rect.height + 'px';
            els.stage.style.width = rect.width + 'px';
            els.stage.style.height = rect.height + 'px';
        }

        function applyGlobalFilters() {
            const f = state.globalFilters;
            els.mainImage.style.filter = `brightness(${f.brightness}%) contrast(${f.contrast}%) saturate(${f.saturate}%) blur(${f.blur}px)`;
        }

        // --- Logic: Interactions ---

        function getStageCoords(e) {
            const rect = els.mainImage.getBoundingClientRect();
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top,
                w: rect.width,
                h: rect.height
            };
        }

        function handleMouseDown(e) {
            if (!state.imageSrc) return;
            if (e.target.closest('button')) return;

            const coords = getStageCoords(e);

            const clampX = Math.max(0, Math.min(coords.x, coords.w));
            const clampY = Math.max(0, Math.min(coords.y, coords.h));

            if (e.target.classList.contains('resize-handle')) {
                state.interactionMode = 'resizing';
                state.activeHandle = e.target.dataset.handle;
                state.transformStart = {
                    x: coords.x, y: coords.y,
                    box: { ...state.selectionBox },
                    path: state.lassoPath.map(p => ({ ...p }))
                };
                return;
            }

            if (e.target.classList.contains('move-area')) {
                state.interactionMode = 'moving';
                state.transformStart = {
                    x: coords.x, y: coords.y,
                    box: { ...state.selectionBox },
                    path: state.lassoPath.map(p => ({ ...p }))
                };
                els.cropMenu.classList.add('hidden');
                return;
            }

            state.interactionMode = 'drawing';
            resetSelection();
            state.startPoint = { x: clampX, y: clampY };

            if (state.currentTool === 'lasso') {
                state.lassoPath = [{ x: clampX, y: clampY }];
            }
        }

        function handleMouseMove(e) {
            if (state.interactionMode === 'none') return;
            if (e.preventDefault) e.preventDefault(); // Stop scroll on touch
            const coords = getStageCoords(e);
            const clampX = Math.max(0, Math.min(coords.x, coords.w));
            const clampY = Math.max(0, Math.min(coords.y, coords.h));

            if (state.interactionMode === 'drawing') {
                updateDrawing(clampX, clampY);
            }
            else if (state.interactionMode === 'moving') {
                updateMoving(coords.x, coords.y);
            }
            else if (state.interactionMode === 'resizing') {
                updateResizing(coords.x, coords.y);
            }
        }

        function handleMouseUp(e) {
            if (state.interactionMode === 'none') return;

            if (state.interactionMode === 'drawing') {
                finalizeDrawing();
            } else {
                showCropMenu();
            }
            state.interactionMode = 'none';
        }

        // --- Logic: Drawing ---

        function updateDrawing(x, y) {
            if (state.currentTool === 'rect') {
                const sx = state.startPoint.x;
                const sy = state.startPoint.y;
                const w = x - sx;
                const h = y - sy;
                state.selectionBox = { x: w > 0 ? sx : x, y: h > 0 ? sy : y, w: Math.abs(w), h: Math.abs(h) };
            }
            else if (state.currentTool === 'circle') {
                const sx = state.startPoint.x;
                const sy = state.startPoint.y;
                const w = x - sx;
                const h = y - sy;
                state.selectionBox = { x: w > 0 ? sx : x, y: h > 0 ? sy : y, w: Math.abs(w), h: Math.abs(h) };
            }
            else if (state.currentTool === 'lasso') {
                state.lassoPath.push({ x, y });
                const xs = state.lassoPath.map(p => p.x);
                const ys = state.lassoPath.map(p => p.y);
                const minX = Math.min(...xs);
                const minY = Math.min(...ys);
                state.selectionBox = { x: minX, y: minY, w: Math.max(...xs) - minX, h: Math.max(...ys) - minY };
            }
            renderVisuals();
        }

        function finalizeDrawing() {
            if (!state.selectionBox || state.selectionBox.w < 5 || state.selectionBox.h < 5) {
                resetSelection();
            } else {
                els.transformBox.style.display = 'block';
                showCropMenu();
            }
        }

        // --- Logic: Transform ---

        function updateMoving(curX, curY) {
            const dx = curX - state.transformStart.x;
            const dy = curY - state.transformStart.y;
            const oldBox = state.transformStart.box;

            state.selectionBox.x = oldBox.x + dx;
            state.selectionBox.y = oldBox.y + dy;

            if (state.lassoPath.length > 0) {
                state.lassoPath = state.transformStart.path.map(p => ({ x: p.x + dx, y: p.y + dy }));
            }
            renderVisuals();
        }

        function updateResizing(curX, curY) {
            const h = state.activeHandle;
            const sb = state.transformStart.box;
            const dx = curX - state.transformStart.x;
            const dy = curY - state.transformStart.y;

            let newX = sb.x, newY = sb.y, newW = sb.w, newH = sb.h;

            if (h.includes('e')) newW = sb.w + dx;
            if (h.includes('s')) newH = sb.h + dy;
            if (h.includes('w')) { newX = sb.x + dx; newW = sb.w - dx; }
            if (h.includes('n')) { newY = sb.y + dy; newH = sb.h - dy; }

            if (newW < 0) { newX += newW; newW = Math.abs(newW); }
            if (newH < 0) { newY += newH; newH = Math.abs(newH); }

            state.selectionBox = { x: newX, y: newY, w: newW, h: newH };

            if (state.lassoPath.length > 0) {
                state.lassoPath = state.transformStart.path.map(p => {
                    const nx = (p.x - sb.x) / sb.w;
                    const ny = (p.y - sb.y) / sb.h;
                    return { x: newX + (nx * newW), y: newY + (ny * newH) };
                });
            }
            renderVisuals();
        }

        function renderVisuals() {
            if (!state.selectionBox) return;
            const { x, y, w, h } = state.selectionBox;

            els.transformBox.style.left = x + 'px';
            els.transformBox.style.top = y + 'px';
            els.transformBox.style.width = w + 'px';
            els.transformBox.style.height = h + 'px';

            els.activeRect.classList.add('hidden');
            els.activeCircle.classList.add('hidden');
            els.activePath.classList.add('hidden');

            if (state.currentTool === 'rect') {
                els.activeRect.setAttribute('x', x);
                els.activeRect.setAttribute('y', y);
                els.activeRect.setAttribute('width', w);
                els.activeRect.setAttribute('height', h);
                els.activeRect.classList.remove('hidden');
            }
            else if (state.currentTool === 'circle') {
                els.activeCircle.setAttribute('cx', x + w / 2);
                els.activeCircle.setAttribute('cy', y + h / 2);
                els.activeCircle.setAttribute('rx', w / 2);
                els.activeCircle.setAttribute('ry', h / 2);
                els.activeCircle.classList.remove('hidden');
            }
            else if (state.currentTool === 'lasso') {
                const d = state.lassoPath.map((p, i) => (i === 0 ? `M ${p.x} ${p.y}` : `L ${p.x} ${p.y}`)).join(' ');
                els.activePath.setAttribute('d', d + ' Z');
                els.activePath.classList.remove('hidden');
            }
        }

        function showCropMenu() {
            if (!state.selectionBox) return;
            els.cropMenu.classList.remove('hidden');
            els.cropMenu.style.left = (state.selectionBox.x + state.selectionBox.w / 2) + 'px';
            els.cropMenu.style.top = (state.selectionBox.y + state.selectionBox.h + 10) + 'px';
        }

        function resetSelection() {
            state.selectionBox = null;
            state.lassoPath = [];
            els.activeRect.classList.add('hidden');
            els.activeCircle.classList.add('hidden');
            els.activePath.classList.add('hidden');
            els.transformBox.style.display = 'none';
            els.cropMenu.classList.add('hidden');
        }

        // --- Logic: Cropping ---

        function performCrop() {
            if (!state.selectionBox) return;
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            const rect = els.mainImage.getBoundingClientRect();
            const scaleX = els.mainImage.naturalWidth / rect.width;
            const scaleY = els.mainImage.naturalHeight / rect.height;

            canvas.width = state.selectionBox.w * scaleX;
            canvas.height = state.selectionBox.h * scaleY;

            // Filters
            const f = state.globalFilters;
            ctx.filter = `brightness(${f.brightness}%) contrast(${f.contrast}%) saturate(${f.saturate}%) blur(${f.blur}px)`;

            // Clip
            ctx.beginPath();
            if (state.currentTool === 'rect') {
                ctx.rect(0, 0, canvas.width, canvas.height);
            } else if (state.currentTool === 'circle') {
                ctx.ellipse(canvas.width / 2, canvas.height / 2, canvas.width / 2, canvas.height / 2, 0, 0, 2 * Math.PI);
            } else if (state.currentTool === 'lasso') {
                state.lassoPath.forEach((p, i) => {
                    const lx = (p.x - state.selectionBox.x) * scaleX;
                    const ly = (p.y - state.selectionBox.y) * scaleY;
                    i === 0 ? ctx.moveTo(lx, ly) : ctx.lineTo(lx, ly);
                });
                ctx.closePath();
            }
            ctx.clip();

            // Draw
            ctx.drawImage(
                els.mainImage,
                state.selectionBox.x * scaleX, state.selectionBox.y * scaleY,
                state.selectionBox.w * scaleX, state.selectionBox.h * scaleY,
                0, 0, canvas.width, canvas.height
            );

            addCrop(canvas.toDataURL('image/png'));
            resetSelection();
        }

        function addCrop(dataUrl) {
            state.crops.unshift({ id: Date.now(), data: dataUrl });
            renderCrops();
            // Show badge on mobile library icon if closed
            if (els.libraryPanel.classList.contains('translate-y-[150%]')) {
                els.mobileLibBadge.classList.remove('hidden');
            }
        }

        function renderCrops() {
            els.cropsContainer.innerHTML = '';
            document.getElementById('crop-counter').innerText = state.crops.length;
            document.getElementById('open-download-modal').disabled = state.crops.length === 0;

            if (state.crops.length === 0) {
                els.cropsContainer.appendChild(els.emptyState);
                return;
            }

            state.crops.forEach(crop => {
                const item = document.createElement('div');
                item.className = 'bg-dark-800 rounded-lg p-2 border border-dark-700 animate-in slide-in-from-left-2 fade-in min-w-[100px] lg:min-w-0';
                item.innerHTML = `
                    <div class="h-16 lg:h-24 bg-checkerboard rounded mb-2 overflow-hidden flex items-center justify-center relative group">
                        <img src="${crop.data}" class="max-w-full max-h-full object-contain">
                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                             <button onclick="editCrop(${crop.id})" class="bg-blue-600 text-white p-1.5 lg:p-2 rounded-full"><i data-lucide="wand-2" class="w-3.5 h-3.5 lg:w-4 lg:h-4"></i></button>
                             <button onclick="openDownloadModal('single', ${crop.id})" class="bg-slate-700 text-white p-1.5 lg:p-2 rounded-full"><i data-lucide="download" class="w-3.5 h-3.5 lg:w-4 lg:h-4"></i></button>
                             <button onclick="deleteCrop(${crop.id})" class="bg-red-900/80 text-white p-1.5 lg:p-2 rounded-full"><i data-lucide="trash-2" class="w-3.5 h-3.5 lg:w-4 lg:h-4"></i></button>
                        </div>
                    </div>
                `;
                els.cropsContainer.appendChild(item);
            });
            lucide.createIcons();
        }

        // --- Download Engine ---

        window.openDownloadModal = (mode, id = null) => {
            state.downloadMode = mode;
            state.singleDownloadId = id;
            els.downloadModal.classList.remove('hidden');
            setTimeout(() => {
                els.downloadModal.classList.remove('opacity-0');
                document.getElementById('download-modal-content').classList.remove('scale-95');
            }, 10);
        };

        function closeDownloadModal() {
            els.downloadModal.classList.add('opacity-0');
            document.getElementById('download-modal-content').classList.add('scale-95');
            setTimeout(() => els.downloadModal.classList.add('hidden'), 200);
        }

        function executeDownload() {
            const format = document.querySelector('input[name="format"]:checked').value;
            const quality = parseFloat(els.dlQualitySlider.value);

            if (state.downloadMode === 'single' && state.singleDownloadId) {
                const crop = state.crops.find(c => c.id === state.singleDownloadId);
                downloadSingleItem(crop, format, quality);
            } else {
                downloadAllItems(format, quality);
            }
            closeDownloadModal();
        }

        function convertFormat(base64Data, format, quality, callback) {
            const img = new Image();
            img.src = base64Data;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                callback(canvas.toDataURL(format, quality));
            };
        }

        function downloadSingleItem(crop, format, quality) {
            const ext = format.split('/')[1];
            convertFormat(crop.data, format, quality, (newData) => {
                const a = document.createElement('a');
                a.href = newData;
                a.download = `crop_${crop.id}.${ext}`;
                a.click();
            });
        }

        function downloadAllItems(format, quality) {
            const zip = new JSZip();
            const folder = zip.folder("studio_crops");
            const ext = format.split('/')[1];
            let processed = 0;

            state.crops.forEach(c => {
                convertFormat(c.data, format, quality, (newData) => {
                    const data = newData.split(',')[1];
                    folder.file(`crop_${c.id}.${ext}`, data, { base64: true });
                    processed++;
                    if (processed === state.crops.length) {
                        zip.generateAsync({ type: "blob" }).then(content => {
                            const a = document.createElement('a');
                            a.href = URL.createObjectURL(content);
                            a.download = "studio_assets.zip";
                            a.click();
                        });
                    }
                });
            });
        }

        // --- Modal & Edit Helpers ---
        window.editCrop = (id) => {
            state.editingCropId = id;
            const crop = state.crops.find(c => c.id === id);
            els.modalPreviewImg.src = crop.data;
            els.editModal.classList.remove('hidden');
            setTimeout(() => {
                els.editModal.classList.remove('opacity-0');
                document.getElementById('edit-modal-content').classList.remove('scale-95');
            }, 10);
        };

        function closeModal() {
            els.editModal.classList.add('opacity-0');
            document.getElementById('edit-modal-content').classList.add('scale-95');
            setTimeout(() => els.editModal.classList.add('hidden'), 200);
        }

        function saveEditedCrop() {
            const crop = state.crops.find(c => c.id === state.editingCropId);
            const f = state.modalFilters;

            const img = new Image();
            img.src = crop.data;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.filter = `brightness(${f.brightness}%) contrast(${f.contrast}%) saturate(${f.saturate}%) blur(${f.blur}px)`;
                ctx.drawImage(img, 0, 0);
                crop.data = canvas.toDataURL('image/png');
                renderCrops();
                closeModal();
            }
        }

        window.deleteCrop = (id) => {
            state.crops = state.crops.filter(c => c.id !== id);
            renderCrops();
        };

    </script>
</body>

</html>