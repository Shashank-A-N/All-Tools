<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SubtitleGenius - AI Subtitle Generator</title>

    <!-- Favicon to fix 404 error -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ¬</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #404040;
            border-radius: 20px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #525252;
        }
    </style>
</head>

<body class="min-h-screen bg-neutral-900 text-neutral-100 selection:bg-purple-500 selection:text-white">

    <!-- API Configuration -->
    <script>
        const apiKey = "AIzaSyDQFw176fa5r3YoIF_q93jU6Zy-L_RPgtA";
    </script>

    <!-- Header -->
    <header class="border-b border-neutral-800 bg-neutral-900/50 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div
                    class="w-8 h-8 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-lg flex items-center justify-center text-white">
                    <span class="font-bold text-lg">S</span>
                </div>
                <h1 class="text-xl font-bold tracking-tight">SubtitleGenius</h1>
            </div>
            <div class="flex items-center gap-4 text-sm text-neutral-400">
                <span>Powered by Gemini 1.5 Flash</span>
                <div class="h-4 w-px bg-neutral-700"></div>
                <a href="#" class="hover:text-white transition-colors">Help</a>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-8">

        <!-- Error Alert -->
        <div id="error-container"
            class="hidden mb-6 p-4 bg-red-500/10 border border-red-500/20 rounded-xl flex items-center gap-3 text-red-200">
            <i data-lucide="alert-circle" class="w-5 h-5 flex-shrink-0"></i>
            <p id="error-message"></p>
            <button onclick="hideError()" class="ml-auto hover:text-white">âœ•</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

            <!-- LEFT COLUMN: Video Player & Upload -->
            <div class="lg:col-span-7 flex flex-col gap-6">

                <!-- Player Container -->
                <div
                    class="bg-black rounded-2xl overflow-hidden shadow-2xl ring-1 ring-white/10 aspect-video relative group flex items-center justify-center">
                    <video id="video-player" class="w-full h-full object-contain hidden" controls playsinline>
                        <track id="subtitle-track" kind="subtitles" label="English (AI)" srclang="en" default>
                        Your browser does not support the video tag.
                    </video>

                    <div id="placeholder-ui"
                        class="absolute inset-0 flex flex-col items-center justify-center text-neutral-500 bg-neutral-950">
                        <i data-lucide="file-video" class="w-16 h-16 mb-4 opacity-50"></i>
                        <p>Upload a video to get started</p>
                    </div>
                </div>

                <!-- Controls -->
                <div class="bg-neutral-800/50 rounded-xl p-6 border border-neutral-800">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 justify-between">

                        <!-- Left: Upload -->
                        <div class="w-full sm:w-auto">
                            <label
                                class="flex items-center justify-center gap-2 bg-neutral-700 hover:bg-neutral-600 text-white px-4 py-2.5 rounded-lg cursor-pointer transition-all w-full sm:w-auto hover:ring-2 hover:ring-neutral-500 hover:ring-offset-2 hover:ring-offset-neutral-800">
                                <i data-lucide="upload" class="w-4 h-4"></i>
                                <span id="upload-text">Upload Video</span>
                                <input type="file" id="file-input" accept="video/*" class="hidden">
                            </label>
                            <p class="text-xs text-neutral-500 mt-2 text-center sm:text-left">
                                Max size: 20MB
                            </p>
                        </div>

                        <!-- Center: Language Selector -->
                        <div class="w-full sm:w-48">
                            <div class="relative">
                                <i data-lucide="languages"
                                    class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-400"></i>
                                <select id="language-select"
                                    class="w-full bg-neutral-900 text-neutral-300 text-sm rounded-lg border border-neutral-700 pl-10 pr-3 py-2.5 focus:ring-purple-500 focus:border-purple-500 outline-none appearance-none cursor-pointer hover:bg-neutral-800 transition-colors">
                                    <option value="English">English</option>
                                    <option value="Spanish">Spanish</option>
                                    <option value="French">French</option>
                                    <option value="German">German</option>
                                    <option value="Italian">Italian</option>
                                    <option value="Portuguese">Portuguese</option>
                                    <option value="Japanese">Japanese</option>
                                    <option value="Korean">Korean</option>
                                    <option value="Chinese">Chinese</option>
                                    <option value="Hindi">Hindi</option>
                                    <option value="Russian">Russian</option>
                                    <option value="Arabic">Arabic</option>
                                </select>
                                <i data-lucide="chevron-down"
                                    class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-500 pointer-events-none"></i>
                            </div>
                        </div>

                        <!-- Right: Actions -->
                        <div class="flex gap-3 w-full sm:w-auto">
                            <button id="generate-btn" disabled
                                class="flex-1 sm:flex-none flex items-center justify-center gap-2 px-6 py-2.5 rounded-lg font-medium transition-all bg-neutral-700 text-neutral-400 cursor-not-allowed">
                                <i data-lucide="sparkles" class="w-4 h-4 icon-default"></i>
                                <i data-lucide="loader-2" class="w-4 h-4 animate-spin hidden icon-loading"></i>
                                <i data-lucide="check-circle-2" class="w-4 h-4 hidden icon-success"></i>
                                <span id="generate-text">Generate</span>
                            </button>

                            <button id="download-btn" disabled
                                class="hidden px-4 py-2.5 bg-neutral-700 hover:bg-neutral-600 text-white rounded-lg transition-colors items-center justify-center gap-2"
                                title="Download .vtt file">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: Subtitle Editor -->
            <div class="lg:col-span-5 h-[600px] lg:h-auto flex flex-col">
                <div
                    class="bg-neutral-800/50 border border-neutral-800 rounded-t-xl p-4 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <i data-lucide="edit-3" class="w-4 h-4 text-purple-400"></i>
                        <h2 class="font-semibold text-neutral-200">Subtitle Editor</h2>
                    </div>
                    <span id="cue-count" class="text-xs font-mono text-neutral-500 bg-neutral-900 px-2 py-1 rounded">0
                        cues</span>
                </div>

                <div id="editor-container"
                    class="flex-1 bg-neutral-900/50 border-x border-b border-neutral-800 rounded-b-xl overflow-y-auto p-2 custom-scrollbar relative">

                    <!-- Empty State -->
                    <div id="editor-empty"
                        class="h-full flex flex-col items-center justify-center text-neutral-500 p-8 text-center">
                        <div id="loading-state" class="hidden flex flex-col items-center gap-3">
                            <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-purple-500"></i>
                            <p class="animate-pulse">Analyzing audio stream...</p>
                        </div>
                        <div id="initial-state">
                            <p class="mb-2">No subtitles yet.</p>
                            <p class="text-sm opacity-60">Upload a video and click Generate to see the magic happen.</p>
                        </div>
                    </div>

                    <!-- List Container -->
                    <div id="subtitle-list" class="space-y-3 hidden pb-8">
                        <!-- Subtitle items injected here -->
                    </div>

                </div>
            </div>

        </div>
    </main>

    <script>
        // --- State Management ---
        const state = {
            videoFile: null,
            subtitles: [],
            isProcessing: false
        };

        // --- DOM Elements ---
        const els = {
            videoPlayer: document.getElementById('video-player'),
            placeholderUi: document.getElementById('placeholder-ui'),
            fileInput: document.getElementById('file-input'),
            uploadText: document.getElementById('upload-text'),
            languageSelect: document.getElementById('language-select'), // Added
            generateBtn: document.getElementById('generate-btn'),
            generateText: document.getElementById('generate-text'),
            downloadBtn: document.getElementById('download-btn'),
            subtitleList: document.getElementById('subtitle-list'),
            editorEmpty: document.getElementById('editor-empty'),
            loadingState: document.getElementById('loading-state'),
            initialState: document.getElementById('initial-state'),
            cueCount: document.getElementById('cue-count'),
            errorContainer: document.getElementById('error-container'),
            errorMessage: document.getElementById('error-message'),
            track: document.getElementById('subtitle-track')
        };

        // --- Utils ---

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = (error) => reject(error);
            });
        }

        function parseVTT(vttText) {
            const lines = vttText.split('\n');
            const cues = [];
            let currentCue = null;

            lines.forEach((line) => {
                line = line.trim();
                if (!line) return;
                if (line === 'WEBVTT') return;

                if (line.includes('-->')) {
                    if (currentCue) cues.push(currentCue);
                    const [start, end] = line.split('-->').map(t => t.trim());
                    currentCue = { id: Date.now() + Math.random(), start, end, text: '' };
                } else if (currentCue) {
                    currentCue.text += (currentCue.text ? '\n' : '') + line;
                }
            });
            if (currentCue) cues.push(currentCue);
            return cues;
        }

        function stringifyVTT(cues) {
            let output = 'WEBVTT\n\n';
            cues.forEach((cue, index) => {
                output += `${index + 1}\n`;
                output += `${cue.start} --> ${cue.end}\n`;
                output += `${cue.text}\n\n`;
            });
            return output;
        }

        function showError(msg) {
            els.errorMessage.textContent = msg;
            els.errorContainer.classList.remove('hidden');
        }

        function hideError() {
            els.errorContainer.classList.add('hidden');
        }

        function jumpToTime(timeStr) {
            const parts = timeStr.split(':');
            let seconds = 0;
            if (parts.length === 3) {
                seconds = (+parts[0]) * 60 * 60 + (+parts[1]) * 60 + parseFloat(parts[2]);
            }
            els.videoPlayer.currentTime = seconds;
            els.videoPlayer.play();
        }

        // --- Render Logic ---

        function updateGenerateButton() {
            const btn = els.generateBtn;
            const icons = {
                def: btn.querySelector('.icon-default'),
                load: btn.querySelector('.icon-loading'),
                success: btn.querySelector('.icon-success')
            };

            // Reset icons
            icons.def.classList.add('hidden');
            icons.load.classList.add('hidden');
            icons.success.classList.add('hidden');

            btn.className = "flex-1 sm:flex-none flex items-center justify-center gap-2 px-6 py-2.5 rounded-lg font-medium transition-all ";

            if (state.isProcessing) {
                btn.classList.add('bg-purple-600', 'text-white', 'animate-pulse', 'cursor-wait');
                icons.load.classList.remove('hidden');
                els.generateText.textContent = "Generating...";
                btn.disabled = true;
            } else if (state.subtitles.length > 0) {
                btn.classList.add('bg-purple-600', 'hover:bg-purple-500', 'text-white', 'shadow-lg');
                icons.success.classList.remove('hidden');
                els.generateText.textContent = "Generated";
                btn.disabled = true;
            } else if (state.videoFile) {
                btn.classList.add('bg-purple-600', 'hover:bg-purple-500', 'text-white', 'shadow-lg', 'shadow-purple-900/20');
                icons.def.classList.remove('hidden');
                els.generateText.textContent = "Generate Subtitles";
                btn.disabled = false;
            } else {
                btn.classList.add('bg-neutral-700', 'text-neutral-400', 'cursor-not-allowed');
                icons.def.classList.remove('hidden');
                els.generateText.textContent = "Generate"; // Shortened text
                btn.disabled = true;
            }
        }

        function updateTrack() {
            if (state.subtitles.length === 0) return;

            const vttString = stringifyVTT(state.subtitles);
            const blob = new Blob([vttString], { type: 'text/vtt' });
            const trackUrl = URL.createObjectURL(blob);

            // Remove old track logic is simpler in vanilla JS by just updating src of existing track element
            // or creating a new one if we want to be safe about caching.

            // Clear existing tracks visually
            els.track.src = trackUrl;

            // Force reload of tracks (sometimes needed for Chrome)
            els.videoPlayer.textTracks[0].mode = 'hidden'; // toggle
            setTimeout(() => {
                els.videoPlayer.textTracks[0].mode = 'showing';
            }, 100);
        }

        function renderEditor() {
            els.cueCount.textContent = `${state.subtitles.length} cues`;

            if (state.subtitles.length === 0) {
                els.subtitleList.classList.add('hidden');
                els.editorEmpty.classList.remove('hidden');
                els.downloadBtn.classList.add('hidden');

                if (state.isProcessing) {
                    els.loadingState.classList.remove('hidden');
                    els.initialState.classList.add('hidden');
                } else {
                    els.loadingState.classList.add('hidden');
                    els.initialState.classList.remove('hidden');
                }
                return;
            }

            els.editorEmpty.classList.add('hidden');
            els.subtitleList.classList.remove('hidden');
            els.downloadBtn.classList.remove('hidden');
            els.downloadBtn.classList.add('flex'); // Ensure flex display

            // Rebuild list
            els.subtitleList.innerHTML = state.subtitles.map((cue, idx) => `
                <div class="group bg-neutral-800 hover:bg-neutral-750 p-3 rounded-lg border border-transparent hover:border-neutral-600 transition-all" data-id="${cue.id}">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-mono text-purple-400 bg-purple-400/10 px-1.5 py-0.5 rounded">#${idx + 1}</span>
                            <button onclick="jumpToTime('${cue.start}')" class="text-xs font-mono text-neutral-400 hover:text-white cursor-pointer hover:underline">${cue.start}</button>
                            <span class="text-neutral-600 text-xs">â†’</span>
                            <span class="text-xs font-mono text-neutral-400">${cue.end}</span>
                        </div>
                        <button onclick="deleteCue(${cue.id})" class="text-neutral-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>
                    <textarea 
                        oninput="updateCueText(${cue.id}, this.value)"
                        class="w-full bg-neutral-900/50 text-neutral-200 text-sm p-2 rounded border border-neutral-700 focus:border-purple-500 focus:ring-1 focus:ring-purple-500 outline-none resize-none transition-colors"
                        rows="2"
                    >${cue.text}</textarea>
                </div>
            `).join('');

            // Re-initialize icons
            lucide.createIcons();

            // Add padding at bottom
            const footer = document.createElement('div');
            footer.className = "text-center pt-4 pb-8 text-neutral-500 text-xs";
            footer.textContent = "End of subtitles";
            els.subtitleList.appendChild(footer);
        }

        // --- Actions ---

        window.updateCueText = (id, value) => {
            const cue = state.subtitles.find(c => c.id === id);
            if (cue) {
                cue.text = value;
                updateTrack(); // Live update video
            }
        };

        window.deleteCue = (id) => {
            state.subtitles = state.subtitles.filter(c => c.id !== id);
            renderEditor();
            updateTrack();
            updateGenerateButton(); // In case list becomes empty
        };

        els.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 20 * 1024 * 1024) {
                showError("File too large. Please upload a video smaller than 20MB for this web demo.");
                return;
            }

            state.videoFile = file;
            state.subtitles = [];
            hideError();

            // UI Updates
            els.videoPlayer.src = URL.createObjectURL(file);
            els.videoPlayer.classList.remove('hidden');
            els.placeholderUi.classList.add('hidden');
            els.uploadText.textContent = "Change Video";

            // Force audio on
            els.videoPlayer.volume = 1.0;
            els.videoPlayer.muted = false;

            updateGenerateButton();
            renderEditor();
        });

        els.generateBtn.addEventListener('click', async () => {
            if (!state.videoFile) return;

            state.isProcessing = true;
            updateGenerateButton();
            renderEditor(); // Show loading state
            hideError();

            try {
                const base64Data = await fileToBase64(state.videoFile);
                const targetLanguage = els.languageSelect.value;

                // Advanced Prompting for better quality
                const systemPrompt = `
                    You are an expert subtitle editor and transcriber. 
                    Your task is to generate frame-accurate WebVTT subtitles for the provided video.
                    
                    TARGET LANGUAGE: ${targetLanguage}
                    
                    STRICT REQUIREMENTS:
                    1. Format: Output MUST start with 'WEBVTT'.
                    2. Precision: Timestamps must be in 'HH:MM:SS.mmm' format and perfectly synchronized with speech.
                    3. Brevity: Keep lines short (maximum 42 characters per line).
                    4. Structure: Use natural phrasing breaks. Max 2 lines per subtitle block.
                    5. Accuracy: Transcribe exactly what is spoken. Do not summarize.
                    6. Noise: Do not subtitle background noise, music, or silence.
                    7. Output: Return ONLY the raw WebVTT content. No markdown code blocks, no explanations.
                `;

                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                role: "user",
                                parts: [
                                    { text: `Generate ${targetLanguage} subtitles.` },
                                    { inlineData: { mimeType: state.videoFile.type, data: base64Data } }
                                ]
                            }],
                            // Added generationConfig for lower temperature (less hallucination)
                            generationConfig: {
                                temperature: 0.2,
                                topK: 40,
                                topP: 0.95,
                                maxOutputTokens: 8192,
                            },
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    }
                );

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const result = await response.json();
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!generatedText) throw new Error("No subtitles generated.");

                const cleanVtt = generatedText.replace(/```vtt/g, '').replace(/```/g, '').trim();
                state.subtitles = parseVTT(cleanVtt);

                updateTrack();

            } catch (err) {
                console.error(err);
                showError(err.message || "Failed to generate subtitles.");
            } finally {
                state.isProcessing = false;
                updateGenerateButton();
                renderEditor();
            }
        });

        els.downloadBtn.addEventListener('click', () => {
            if (state.subtitles.length === 0) return;
            const element = document.createElement("a");
            const file = new Blob([stringifyVTT(state.subtitles)], { type: 'text/vtt' });
            element.href = URL.createObjectURL(file);
            element.download = "subtitles.vtt";
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        });

        // Initialize Icons on load
        lucide.createIcons();
    </script>
</body>

</html>